<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Yucong&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="No matter where we are going, it starts from where we are">
<meta property="og:type" content="website">
<meta property="og:title" content="Yucong's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Yucong's Blog">
<meta property="og:description" content="No matter where we are going, it starts from where we are">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yucong's Blog">
<meta name="twitter:description" content="No matter where we are going, it starts from where we are">
  
    <link rel="alternative" href="/atom.xml" title="Yucong&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/assets/img/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">体力劳动者</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">All</a></li>
				        
							<li><a href="/tags/Frameworks">Frameworks &amp; Libraries</a></li>
				        
							<li><a href="/tags/Javascript">Javascript</a></li>
				        
							<li><a href="/tags/css">Css</a></li>
				        
							<li><a href="/tags/随笔">随笔</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/BigYu" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/1798448072" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jin-yu-cong" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="mailto:jinyucong911@outlook.com" title="mail">mail</a>
					        
								<a class="facebook" target="_blank" href="https://www.facebook.com/profile.php?id=100007633386209" title="facebook">facebook</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/TinyJYC" title="twitter">twitter</a>
					        
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Backbone/" style="font-size: 10px;">Backbone</a> <a href="/tags/Dom/" style="font-size: 10px;">Dom</a> <a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/ES6-ES2015/" style="font-size: 12.5px;">ES6(ES2015)</a> <a href="/tags/Events/" style="font-size: 10px;">Events</a> <a href="/tags/Framework/" style="font-size: 10px;">Framework</a> <a href="/tags/Frameworks/" style="font-size: 15px;">Frameworks</a> <a href="/tags/Javascript/" style="font-size: 20px;">Javascript</a> <a href="/tags/Vue-js/" style="font-size: 10px;">Vue.js</a> <a href="/tags/css/" style="font-size: 12.5px;">css</a> <a href="/tags/data-binding/" style="font-size: 12.5px;">data binding</a> <a href="/tags/framework/" style="font-size: 12.5px;">framework</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/javascript/" style="font-size: 17.5px;">javascript</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
					</div>
				</section>
				

				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">No matter where we are going, it starts from where we are</div>
				</section>
				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">体力劳动者</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img lazy-src="/assets/img/avatar.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">体力劳动者</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">All</a></li>
		        
					<li><a href="/tags/Frameworks">Frameworks &amp; Libraries</a></li>
		        
					<li><a href="/tags/Javascript">Javascript</a></li>
		        
					<li><a href="/tags/css">Css</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/BigYu" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/1798448072" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jin-yu-cong" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="mailto:jinyucong911@outlook.com" title="mail">mail</a>
			        
						<a class="facebook" target="_blank" href="https://www.facebook.com/profile.php?id=100007633386209" title="facebook">facebook</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/TinyJYC" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-easy-ui" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/11/easy-ui/" class="article-date">
  	<time datetime="2017-12-11T02:26:12.000Z" itemprop="datePublished">2017-12-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/11/easy-ui/">Make UI development easy again</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作为前端开发者经常有被其他领域的工程师质疑：“你整天都在忙啥。不就是写个UI有那么难么？”当然我们可以找出很多例子来证明UI真的可以很难很高科技，比如说amazon那个魔术一般的wunderbar，但是我们加班真的在忙这些东西吗？我猜测绝大多数人跟我一样，头疼的task和bug都来自于无穷无尽的entity CRUD，表单，表格当中。所以我个人是很想赞同他们的质疑：“前端真的有那么难吗？”</p>
<h1 id="It-was-easy"><a href="#It-was-easy" class="headerlink" title="It was easy"></a>It was easy</h1><p>若干年之前，我们并没有javascript，也没有SPA，那时的web应用开发是非常简单清晰的。我们以经典的ROR（ruby on rails, 很多被广泛的使用的框架，如structs，spring, Yii, asp.net都深受其影响）为例：</p>
<p>建表(当然production中这么建表被fire了后果自负)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> (</div><div class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) NNOT <span class="literal">NULL</span> auto_increment,</div><div class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</div><div class="line">  <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>model</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></div><div class="line">  validates <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  before_create <span class="keyword">do</span></div><div class="line">    <span class="keyword">self</span>.name = login.capitalize <span class="keyword">if</span> name.blank?</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>view</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span></div><div class="line"><span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> form_tag(<span class="string">"/login"</span>, <span class="symbol">method:</span> <span class="string">"post"</span>) <span class="keyword">do</span> </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> text_field_tag(<span class="symbol">:name</span>) </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> password_field_tag(<span class="symbol">:password</span>) </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> submit_tag(<span class="string">"Search"</span>) </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%</span></span><span class="ruby"> <span class="keyword">end</span> </span><span class="xml"><span class="tag">%&gt;</span></span></div></pre></td></tr></table></figure>
<p>controller</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginsController</span> &lt; ApplicationController</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span></span></div><div class="line">    <span class="keyword">if</span> user = User.authenticate(params[<span class="symbol">:username</span>], params[<span class="symbol">:password</span>])</div><div class="line">      session[<span class="symbol">:current_user_id</span>] = user.id</div><div class="line">      redirect_to landing_url</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>这一切很简单，在经典的MVC+serverside rendering的架构中，controller和model都是在server side运行,controller来管理business logic：调用哪个model（User），进行什么操作（authenticate），结果是什么（成功则跳转），model用来管理数据：User的字段,query（本例中映射到数据库）等操作。而view，很诚实的根据model里的数据来渲染页面，提交表单。我们没有JavaScript，发不出change，onClick事件，没有办法在view里面进行正则验证，这些逻辑都由controller完成。</p>
<p><em>Recap</em>：</p>
<ol>
<li>UI = f(model),不会受其他data binding或者events的影响</li>
<li>view和controller之间划分了一条明显的界限</li>
</ol>
<p>好处：</p>
<ol>
<li>简单清晰，开发效率高，学习成本低</li>
<li>想象我们现在不用ejs作为模板引擎了，比如说用pug，controller基本不用啥改动。同样的，现在我们把db用mongodb替代mysql（事实上，我推荐个人小项目这么干），view基本不用改。</li>
</ol>
<p>你换angular试试？把validate写进filter里:P</p>
<h2 id="why-we-move-away"><a href="#why-we-move-away" class="headerlink" title="why we move away"></a>why we move away</h2><p>To reduce UI friction!!</p>
<ol>
<li>每次重新渲染页面的perf无法接受</li>
<li>复杂交互的需求：animation等</li>
</ol>
<p>拿这写个gmail？微软的卧底才这么干。还是用angular吧=.=</p>
<h2 id="why-we-want-it-again"><a href="#why-we-want-it-again" class="headerlink" title="why we want it again?"></a>why we want it again?</h2><p>现在前端有大量MVC，MVVM框架，他们很优秀解决了无数的问题，但同时也引起开篇提出的质疑：现在前端是加班重灾区（jquery要接大锅，但与本文主题无关，略，并且相对于功劳，它不优雅之处并非主要）立下汗马功劳的events机制和data binding反过来在bite我们：</p>
<ol>
<li><p>hard bugs</p>
<p>在campaign creation的第一步和第四步，我们有两次让用户set buget的机会。如果我们让这两个budget control是一个instance:因为每一步的next和back button都会validate当前step所有的form,那么实际上，第一步和第四步的都执行了自己步骤以外的validation，这导致了很多bug；如果让他们是不同的instance，需要构造两次不说，其他受budget影响的component都需要监听或者分辨来自不同budget control的事件，或者判断传入的instance是不是当前想要的。数据和validation同步也是可能导致问题的。</p>
</li>
<li><p>DCR and rebranding</p>
<p>我们做了决定，deprecate monthly budget。然而 有很多已经存在的campaign apply了monthly budget， 所以settings页面需要保留monthly选项，creation页面需要删掉。</p>
<p>当我们已经在pilot 紧张的准备GA的时候，另外一个feature也要开始准备release了：shared budget。原来的budget control成为了一个child 和shared budget的control一起组成新的budget panel：所有的事件和接口，都需要转发。</p>
</li>
<li><p>painful debugging experience</p>
<p>我们有很多别的限制：不同的location，不同的language，budget的currency和limitation不一样，同时，bid是受到budget的限制的，traffic estimation是收到budget影响的。<br>别忘了，我们有两个budget control，而且未来有可能，面包屑上方的header里，会出现第三个。<br>别忘了，shared budget是和别的campaign关联的。budget除了value，还有type。是的，type还会变。你可以想象到我们在调试其中关于validation,关于filter，关于format，等等，bug的时候，不知道root cause在哪一脸懵逼的表情吗。</p>
</li>
<li><p>async</p>
<p>我们的render和destroy方法都是同步的。因为lazy loading的需求，我们需要在render的时候再加载一个第三方库，加载成功之后会创建一系列新的实体在其子节点上。destroy的时候，需要讲他们一一销毁：这时，一个很容易出bug的问题诞生了：你怎么知道destroy的时候render及其异步操作已经全部完成。稍不小心就会让程序进入无法预测的异常状态。</p>
<p>（1）改框架，render和destroy都支持promise。</p>
<ul>
<li>好主意，加油（微笑）争取明年release（doge）<br>（2）加全局flag</li>
<li>我们确实很多时候是怎么干的。</li>
<li>异步之后又fork出新的异步task怎么办</li>
<li>你怎么能保证线程安全？怎么能保证flag不被修改？如果之后的业务告诉你确实要修改flag怎么办？比如说，有两个同时进行的lazy loading。掀桌。</li>
</ul>
</li>
</ol>
<p>哦，对了，我们GA了之后，另外一个crew开始在我们的基础上做multiple language。原来language由enum，成为了数组或者enum。嗯。。。<br>我们加班就是在干这样的事情的。</p>
<h1 id="Make-it-easy-again"><a href="#Make-it-easy-again" class="headerlink" title="Make it easy again"></a>Make it easy again</h1><h2 id="We-want-both"><a href="#We-want-both" class="headerlink" title="We want both"></a>We want both</h2><p>回想一下我们为什么放弃了那些田园时代美好的东西：1. perf 2. ux requirements</p>
<p>不就是把server sider rendering换成client side rendering嘛，其他的逻辑组织一切都不变，真个平移到client side。或者说用javascript强行写一个ror或者asp.net搁浏览器里跑，可行吗？</p>
<p>当然可行，不过频繁的dom操作，依然让perf和体验不理想，可以归结为ui friction。好吧，我们写angular吧，我们写knockout吧，我们写backbone吧。</p>
<p>喷了一大圈，那些大神们果然还是比我们厉害啊。</p>
<h3 id="Not-a-blocker-now"><a href="#Not-a-blocker-now" class="headerlink" title="Not a blocker now"></a>Not a blocker now</h3><p>没想到现在我们迎来了一个大救星：virtual dom。放心的render，rerender吧，virtual dom刚我们干了reduce ui friction的活儿。咱们放心前进。</p>
<p>另一方面，对于很多局部的小控件，其实啊，重画是完全可以接受的，并不是ui friction，比方说，你就是一个小小的date picker之类的。</p>
<p>好了，现在我们可以回头找一下那一些被迫放弃的田园时代的美好吧。、</p>
<p><em>Recap</em>：</p>
<ol>
<li>UI = f(model),不会受其他data binding或者events的影响</li>
<li>view和controller之间划分了一条明显的界限</li>
</ol>
<h2 id="How？"><a href="#How？" class="headerlink" title="How？"></a>How？</h2><h3 id="状态递归"><a href="#状态递归" class="headerlink" title="状态递归"></a>状态递归</h3><p>controller是啥？描述状态转移的。compose出新的model 把这个新的model，交给新的view</p>
<p><strong>controller: old_model -&gt; new_model</strong></p>
<p>根据什么计算？废话，传进来的参数啊。别的东西我看不见看不见。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">new_model = r(old_model, params)</div></pre></td></tr></table></figure>
<p>在这里，我们并不像局限于某一种特定的pattern来讨论这些问题：viewmodel还是model，who cares？我们可以都叫他state</p>
<p>params也太局限了，我们也不想局限于某一种代码组织方式，controller function？controller class？这不重要，我们是来推销哲学的。我们就叫它action吧。</p>
<p>敲黑板，划重点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">state_next = r(state, action)</div></pre></td></tr></table></figure>
<p>r is a pure function!r is a pure function!r is a pure function!</p>
<h3 id="UI-f-state"><a href="#UI-f-state" class="headerlink" title="UI = f(state)"></a>UI = f(state)</h3><p>和以上同样的想法，把model扩展成state状态得到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UI = f(state)</div></pre></td></tr></table></figure>
<p>f is a pure function!f is a pure function!f is a pure function!</p>
<h3 id="pure-function"><a href="#pure-function" class="headerlink" title="pure function"></a>pure function</h3><ol>
<li>what</li>
</ol>
<ul>
<li>Given the same input, will always return the same output. 给定输入，则输出给定。</li>
<li>Produces no side effects. 没有副作用。</li>
</ul>
<p>The simplest reusable building blocks of code in a program</p>
<ul>
<li>Immune to entire classes of bugs that have to do with shared mutable state</li>
<li>Great candidates for parallel processing</li>
<li>Easy to move around</li>
</ul>
<p><em>FP(functional programing)的数学背景(如果时间允许且听众感兴趣的话)</em></p>
<p>(1) Category theory</p>
<p>(解释了为什么pure function对干扰免疫，没有副作用)<br>(思考问题的时候，一定注意把pure function理解成pipe，而不是execute，重点！pipe！)</p>
<ul>
<li>category: an algebraic structure that comprises “objects” that are linked by “arrows“</li>
<li>Consider the “category” as “container” which contains:<ul>
<li>values</li>
<li>transforming of values</li>
</ul>
</li>
</ul>
<p>(2) λ calc(lambda演算 然而JavaScript里的lambda 表达式不是真lambda表达式)</p>
<ul>
<li>λ-terms（解释了为什么“函数是一等公民”）<ul>
<li>variables: x</li>
<li>function creation/abstraction: λx.E</li>
<li>function application: E1 E2</li>
</ul>
</li>
<li>evaluation（解释了柯里化的数学原理，解释了FP对于异步和并行的优势，启发我们不要用传统的考虑“值”的思路（call by value）去理解而是call by name）<ul>
<li>Alpha equivalence( or conversion )</li>
<li>Beta reduction<ul>
<li>call by value</li>
<li>call by name</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li>why</li>
</ol>
<ul>
<li>we want UI to be predicable</li>
<li>we want UI transforming be predicable</li>
</ul>
<p>(不要拿随机数生成来抬杠，因为随机数的生成，是需要seed的)</p>
<ol>
<li>benefits</li>
</ol>
<ul>
<li>Easy to control the order</li>
<li>Easy to pass in additional data</li>
<li>Easy to make reusable reduce functions</li>
</ul>
<ol>
<li>How</li>
</ol>
<ul>
<li>currying</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">status</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">      <span class="comment">// fancy logging code here</span></div><div class="line">    &#125;;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> info = log(<span class="string">'info'</span>); <span class="comment">// create a new function "info" by fixing first argument</span></div><div class="line">info(<span class="string">'db-context'</span>)(<span class="string">'message'</span>);</div><div class="line"></div><div class="line">log(<span class="string">'other level'</span>)(<span class="string">'some context'</span>)(<span class="string">'a message'</span>); <span class="comment">// use the original function directly with all arguments</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> dbInfo = info(<span class="string">'db'</span>); <span class="comment">// create a new function again</span></div><div class="line">dbInfo(<span class="string">'something happened'</span>);</div></pre></td></tr></table></figure>
<ul>
<li>partial</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">status, context, message</span>) </span>&#123;</div><div class="line">  <span class="comment">// fancy logging code here</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params">context, message</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> log(<span class="string">'info'</span>, context, message);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">dbInfo</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> info(<span class="string">'db'</span>, message);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>immutable</p>
<ul>
<li>Some side effects avoided.</li>
<li>Pure functions easier to write.</li>
<li>Fast change detection.</li>
<li>Immutable data can be safely cached.</li>
<li>Easier to implement undo.</li>
<li>Concurrency.</li>
</ul>
</li>
</ul>
<h3 id="Deep-in-r-centralized-state-management"><a href="#Deep-in-r-centralized-state-management" class="headerlink" title="Deep in r - centralized state management"></a>Deep in r - centralized state management</h3><ol>
<li><p>state is read-only</p>
<ul>
<li>It is immutability</li>
<li>all changes are centralized and happen one by one in a strict order</li>
<li>Easy to be logged, serialized, stored, and later replayed for debugging or testing purposes.</li>
</ul>
</li>
<li><p>Changes are made with pure functions</p>
</li>
</ol>
<h3 id="Deep-in-f-UI-as-function-of-state"><a href="#Deep-in-f-UI-as-function-of-state" class="headerlink" title="Deep in f - UI as function of state"></a>Deep in f - UI as function of state</h3><ol>
<li>One-way data binding</li>
<li>single source of truth</li>
</ol>
<h1 id="Tail"><a href="#Tail" class="headerlink" title="Tail"></a>Tail</h1><p>我们不是来sell某一种框架或者技术的。更多的是想抛砖引玉，启发大家如何借助一些最新的力量，在保留我们已有的财富的同时，找到一次前端的“文艺复新”。当然和文艺复新一样，这里也是旧瓶装新酒。这里的flux pattern和传统的MVC相比，也有了不少变化，下面会说明。</p>
<p>可能喜欢在技术上赶时髦的同学已经想把那几个框架或者技术的名字呼之欲出了。但是这不是这里想要deliver的东西。这里只是讲一种pattern，我们更希望它随时随地，哪怕我们在处理没有用那些新的框架的时候，也能启发我们，让我们的工作更加简单。用到的时候，更能体会作者的良苦用心，为什么这样做，而不是API的搬运工。事实上，这种思考问题的方法，这种设计的思路，真的不需要通过哪个框架或者技术才能实现。Jquery？Why not？</p>
<h2 id="case-study-projection-grid"><a href="#case-study-projection-grid" class="headerlink" title="case study: projection-grid"></a>case study: projection-grid</h2><ol>
<li>predicable: 只要projection确定了，内容就确定。</li>
<li>renderer并不关注projection如何被pipe，如何被compose，只需要关心render model长什么样子就能画出grid</li>
<li>React，vue，backbone版本只是renderer不一样，如何计算render model完全不用重复。所以：不同情形下可以重用同一份plugin！</li>
<li>Debug：只需要关注render model，就能查找是compose model发生的错误还是在render时发生。</li>
<li>Test：对于core，只需要关注IO，对于renderer，只需要关注给定render model之后的snapshot。</li>
<li>Extensibility: 通过pipe更多的plugin。plugin是pure function或plain object(这是语法糖，实际上我们都处理成reducer，即，根据现有配置和参数（state and action）返回新的配置（new state）)</li>
</ol>
<h2 id="Flux-pattern"><a href="#Flux-pattern" class="headerlink" title="Flux pattern"></a>Flux pattern</h2><ul>
<li>View: representation layer. Controller views.</li>
<li>Action: raise actions from representational layer.</li>
<li>Dispatcher: receive actions and invoke callbacks.</li>
<li>Store: respond to dispatched actions.</li>
</ul>
<h3 id="Controller-Views-Pattern"><a href="#Controller-Views-Pattern" class="headerlink" title="Controller Views Pattern"></a>Controller Views Pattern</h3><ul>
<li>Separate controllers(container components) and views(representational components)</li>
<li>Benefits<ul>
<li>More portable.</li>
<li>Less cognitive overhead.</li>
<li>Easier testing.</li>
</ul>
</li>
</ul>
<h2 id="Frequende-asked-questions"><a href="#Frequende-asked-questions" class="headerlink" title="Frequende asked questions:"></a>Frequende asked questions:</h2><p>Q: how to share components to public?<br>A:</p>
<ul>
<li>We share widgets and controls. we should not share business.</li>
<li>We can share universal helper functions in typical pure function way.</li>
<li>Pure functions are even easier to share: No side effects. Predicable</li>
<li>Higher ordered components.</li>
</ul>
<p>Q: how to compose async actions?<br>A:<br>这不就是λx condition的问题吗？柯里化。看似复杂的问题背后一定有简单的数学原理。</p>
<p>Q: In big team co-work, how to break projects down?<br>A</p>
<ul>
<li>Trandional: application -&gt; modules -&gt; controllers + views + models(viewmodels) | MVVM or other patterns</li>
<li>Applying middleware:(如果我们用函数式思考，一切非常自然)<ul>
<li>application = middleware1(middleware2(middleware3(…midlewareN(config))))</li>
<li>or application = middleware1(config1)(middleware2(config2))(…)(middlewareN(configN))</li>
</ul>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-deps-collection" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/18/deps-collection/" class="article-date">
  	<time datetime="2017-10-18T02:22:55.000Z" itemprop="datePublished">2017-10-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/18/deps-collection/">Data binding: hijack and dependencies collection</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>见过的前端js框架，data-binding的实现方案大致有三种：</p>
<ul>
<li>直接把数据的暴露成function,如knockout</li>
<li>dirty check, 如angular</li>
<li>劫持getter,setter + 依赖收集,如vue</li>
</ul>
<p>写下第三种：</p>
<p><a href="https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js" target="_blank" rel="external">Vue 源码</a></p>
<p>我们的demo code是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">form</div><div class="line">  input(type=&quot;text&quot;, v-bind=&quot;count&quot;)</div><div class="line">  button(type=&quot;button&quot;, v-click=&quot;increment&quot;) increment</div><div class="line">div(v-bind=&quot;count&quot;)</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; Observable, Watcher &#125; <span class="keyword">from</span> <span class="string">'@bingads-webui/simple-observable'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> Observable(&#123;</div><div class="line">  firstName: <span class="string">'Michael'</span>,</div><div class="line">  lastName: <span class="string">'Jordan'</span>,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">new</span> Watcher(person, <span class="string">'fullName'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;person.firstName&#125;</span> <span class="subst">$&#123;person.lastName&#125;</span>`</span>;</div><div class="line">&#125;, (val) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`The full name is <span class="subst">$&#123;val&#125;</span>`</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(person.fullName);</div><div class="line"></div><div class="line">person.lastName = <span class="string">'Jackson'</span>;</div><div class="line"></div><div class="line"><span class="built_in">window</span>.person = person;</div></pre></td></tr></table></figure>
<p>带dom操作的:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'@bingads-webui/simple-observable'</span>;</div><div class="line"><span class="keyword">import</span> template <span class="keyword">from</span> <span class="string">'./index.pug'</span>;</div><div class="line"></div><div class="line"><span class="keyword">new</span> App(&#123;</div><div class="line">  el: <span class="built_in">document</span>.body,</div><div class="line">  template,</div><div class="line">  data: &#123;</div><div class="line">    count: <span class="number">3</span>,</div><div class="line">  &#125;,</div><div class="line">  method: &#123;</div><div class="line">    increment: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">this</span>.data.count++;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h1><h2 id="在属性被读写的时候主动通知："><a href="#在属性被读写的时候主动通知：" class="headerlink" title="在属性被读写的时候主动通知："></a>在属性被读写的时候主动通知：</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> person = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="keyword">let</span> firstName = <span class="string">'Michael'</span>;</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(person, <span class="string">'firstName'</span>, &#123;</div><div class="line">  get() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Reading person.firstName'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'Michael'</span>;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  set(val) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Setting person.firstName <span class="subst">$&#123;val&#125;</span>`</span>);</div><div class="line"></div><div class="line">    firstName = val;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们可以定义最基本的observable类和defineReactive方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</div><div class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      <span class="comment">// todo</span></div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    set(newVal) &#123;</div><div class="line">      <span class="comment">// todo</span></div><div class="line"></div><div class="line">      val = newVal;</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">obervable</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj);</div><div class="line"></div><div class="line">  keys.forEach((key) =&gt; &#123;</div><div class="line">    defineReactive(obj, key, obj[key]);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Refactor一下，写成class</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observable</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.walk(obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  walk(obj) &#123;</div><div class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj);</div><div class="line"></div><div class="line">    keys.forEach((key) =&gt; &#123;</div><div class="line">      <span class="keyword">this</span>.defineReactive(obj, key, obj[key]);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineReactive(obj, key, val) &#123;</div><div class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        <span class="comment">// todo</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set(newVal) &#123;</div><div class="line">        <span class="comment">// todo</span></div><div class="line"></div><div class="line">        val = newVal;</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h1><p>现在来实现demo中的这个部分：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Watcher(person, <span class="string">'fullName'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;person.firstName&#125;</span> <span class="subst">$&#123;person.lastName&#125;</span>`</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>(有没有觉得和dirty check里面的$$watchers很像。。。后面还有更像的)</p>
<ul>
<li>watcher属性无法被赋值</li>
<li>watcher的值由第三个参数决定</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">watcher</span>(<span class="params">obj, key, getVal</span>) </span>&#123;</div><div class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      <span class="keyword">const</span> val = getVal();</div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line">    set() &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot set values of wathers.'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>改写成watcher类并加入listener</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj, key, cb， onComputedUpdate) &#123;</div><div class="line">    <span class="keyword">this</span>.obj = obj;</div><div class="line">    <span class="keyword">this</span>.key = key;</div><div class="line">    <span class="keyword">this</span>.cb = cb;</div><div class="line">    <span class="keyword">this</span>.onComputedUpdate = onComputedUpdate;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.defineComputed();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineComputed() &#123;</div><div class="line">    <span class="keyword">const</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> onDepUpdated = () =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.obj, <span class="keyword">this</span>.key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        <span class="keyword">const</span> val = self.cb();</div><div class="line">        <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set() &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot set values of wathers.'</span>);</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样observable和watcher就可以一起工作了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> Observable(&#123; firstName: <span class="string">'Michael'</span>, lastName: <span class="string">'Jordan'</span> &#125;);</div><div class="line"></div><div class="line"><span class="keyword">new</span> Watcher(person, <span class="string">'fullName'</span>, () =&gt; <span class="string">`<span class="subst">$&#123;person.firstName&#125;</span> <span class="subst">$&#123;person.lastName&#125;</span>`</span>, (val) =&gt; &#123; <span class="built_in">console</span>.log(<span class="string">`new value <span class="subst">$&#123;val&#125;</span>`</span>) &#125;);</div></pre></td></tr></table></figure>
<h1 id="Dependencies-collection"><a href="#Dependencies-collection" class="headerlink" title="Dependencies collection"></a>Dependencies collection</h1><p>这样有一个问题：我们是主动去取fullName的值的时候，它才会被计算。而我们期望的行为，是firstName或者lastName被修改的时候，主动通知fullName，并更新,触发onComputedUpdate。<br>可以设计这样一个dependency collector, 来收集所有的dependencies. 具体一点就是,让一个observable知道有哪些watcher依赖它,并且在自己被赋值的时候通知watcher.</p>
<p>注意到watcher的getter被call到的时候,它依赖哪些observable,就会call到这些observable,可以用这个时机来告诉observable,这个watcher依赖你了.然后在call到setter时,就可以把dependencies拿出来通知:</p>
<p>简单版本,拿一个全局变量存dependencies做依赖收集器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Dep = &#123;</div><div class="line">  target: <span class="literal">null</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>在watcher中:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">defineComputed() &#123;</div><div class="line">  <span class="keyword">const</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">  <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.obj, <span class="keyword">this</span>.key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      Dep.target = () =&gt; &#123;</div><div class="line">        <span class="keyword">const</span> val = self.cb();</div><div class="line">        <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    set() &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot set values of wathers.'</span>);</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在observable中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">defineReactive(obj, key, val) &#123;</div><div class="line">  <span class="keyword">const</span> deps = [];</div><div class="line"></div><div class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      deps.push(Dep.target);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    set(newVal) &#123;</div><div class="line">      val = newVal;</div><div class="line">      deps.forEach(dep =&gt; dep());</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'underscore'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>() &#123;</div><div class="line">    <span class="keyword">this</span>.deps = [];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  depend() &#123;</div><div class="line">    <span class="keyword">if</span> (Dep.target &amp;&amp; <span class="keyword">this</span>.deps.indexOf(Dep.target) === <span class="number">-1</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.deps.push(Dep.target);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  notify() &#123;</div><div class="line">    <span class="keyword">this</span>.deps.forEach((dep) =&gt; &#123;</div><div class="line">      dep();</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Dep.target = <span class="literal">null</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observable</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.walk(obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  walk(obj) &#123;</div><div class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj);</div><div class="line"></div><div class="line">    keys.forEach((key) =&gt; &#123;</div><div class="line">      <span class="keyword">this</span>.defineReactive(obj, key, obj[key]);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineReactive(obj, key, val) &#123;</div><div class="line">    <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep();</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        dep.depend();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set(newVal) &#123;</div><div class="line">        val = newVal;</div><div class="line">        dep.notify();</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj, key, cb, onComputedUpdate) &#123;</div><div class="line">    <span class="keyword">this</span>.obj = obj;</div><div class="line">    <span class="keyword">this</span>.key = key;</div><div class="line">    <span class="keyword">this</span>.cb = cb;</div><div class="line">    <span class="keyword">this</span>.onComputedUpdate = onComputedUpdate;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.defineComputed();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineComputed() &#123;</div><div class="line">    <span class="keyword">const</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> onDepUpdated = () =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.obj, <span class="keyword">this</span>.key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        Dep.target = onDepUpdated;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">        Dep.target = <span class="literal">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set() &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot assign value computed!'</span>);</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(&#123; el, template, data, method &#125;) &#123;</div><div class="line">    <span class="keyword">this</span>.el = el;</div><div class="line">    <span class="keyword">this</span>.template = template;</div><div class="line">    <span class="keyword">this</span>.data = <span class="keyword">new</span> Observable(data);</div><div class="line">    <span class="keyword">this</span>.method = method;</div><div class="line">    <span class="keyword">this</span>.render();</div><div class="line">    <span class="keyword">this</span>.applyBindings();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  applyBindings() &#123;</div><div class="line">    <span class="keyword">const</span> bindList = <span class="keyword">this</span>.el.querySelectorAll(<span class="string">'[v-bind]'</span>);</div><div class="line"></div><div class="line">    _.each(bindList, (bind) =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> bindKey = bind.getAttribute(<span class="string">'v-bind'</span>);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (bind.tagName === <span class="string">'INPUT'</span>) &#123;</div><div class="line">        <span class="comment">// bind.value = this.data[bindKey];</span></div><div class="line"></div><div class="line">        <span class="keyword">new</span> Watcher(<span class="keyword">this</span>.data, <span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>Value`</span>, () =&gt; &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.data[bindKey];</div><div class="line">        &#125;, (newVal) =&gt; &#123;</div><div class="line">          bind.value = newVal;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        bind.value = <span class="keyword">this</span>.data[<span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>Value`</span>];</div><div class="line"></div><div class="line">        bind.addEventListener(<span class="string">'input'</span>, (e) =&gt; &#123;</div><div class="line">          <span class="keyword">this</span>.data[bindKey] = e.target.value;</div><div class="line">        &#125;);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">new</span> Watcher(<span class="keyword">this</span>.data, <span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>InnerHtml`</span>, () =&gt; &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.data[bindKey];</div><div class="line">        &#125;, (newVal) =&gt; &#123;</div><div class="line">          bind.innerHTML = newVal;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        bind.innerHTML = <span class="keyword">this</span>.data[<span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>InnerHtml`</span>];</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> clickList = <span class="keyword">this</span>.el.querySelectorAll(<span class="string">'[v-click]'</span>);</div><div class="line"></div><div class="line">    _.each(clickList, (click) =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> clickKey = click.getAttribute(<span class="string">'v-click'</span>);</div><div class="line">      <span class="keyword">const</span> clickFunc = <span class="keyword">this</span>.method[clickKey];</div><div class="line"></div><div class="line">      click.onclick = clickFunc.bind(<span class="keyword">this</span>);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">this</span>.el.innerHTML = <span class="keyword">this</span>.template();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-binding/">data binding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/framework/">framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-dirty-check" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/11/dirty-check/" class="article-date">
  	<time datetime="2017-10-11T07:31:04.000Z" itemprop="datePublished">2017-10-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/11/dirty-check/">data-binding: dirty check</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>见过的前端js框架，data-binding的实现方案大致有三种：</p>
<ul>
<li>直接把数据的暴露成function,如knockout</li>
<li>dirty check, 如angular</li>
<li>劫持getter,setter + 依赖收集,如vue</li>
</ul>
<p>自己实现了一个非常简化的dirty-check</p>
<h1 id="watchers"><a href="#watchers" class="headerlink" title="$$watchers"></a>$$watchers</h1><p>scope是angular中最重要的一个概念，这里不再重复。用dirty check来实现data binding,scope中的$$watchers起到了核心的作用。$$watchers是一个数组，用于存放scope下所有的数据。每个数据有以下几个字段：</p>
<ul>
<li>name: 变量名，就是$scope.someName中的someName</li>
<li>last: 变量上一次的值，这是一个值。</li>
<li>newVal: 获取新值的函数，这是个函数。</li>
<li>listener: 监听的回掉函数。</li>
</ul>
<h1 id="watch"><a href="#watch" class="headerlink" title="$watch"></a>$watch</h1><p>将一个新的成员加入$$watchers</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$watch(name, exp, listener = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;) &#123;</div><div class="line">  <span class="keyword">this</span>.$$watchers.push(&#123;</div><div class="line">    name,</div><div class="line">    last: <span class="string">''</span>,</div><div class="line">    newVal: exp,</div><div class="line">    listener,</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有了$watch方法，我们就可以把scope中的所有值都加入$$watchers:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> $scope) &#123;</div><div class="line">  <span class="keyword">if</span> (key != <span class="string">'$$watchers'</span> &amp;&amp; !_.isFunction($scope[key])) &#123;</div><div class="line">    $scope.$watch(key, () =&gt; $scope[key]);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="digest"><a href="#digest" class="headerlink" title="$digest"></a>$digest</h1><p>$digest的作用，就是遍历$$watchers里所有的值，比较新值和旧值，调用listener，并把新值赋值给last,直到所有的新值旧值都相等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$digest() &#123;</div><div class="line">  <span class="keyword">let</span> dirty = <span class="literal">true</span>;</div><div class="line"></div><div class="line">  <span class="keyword">while</span> (dirty) &#123;</div><div class="line">    dirty = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    _.each(<span class="keyword">this</span>.$$watchers, (watcher) =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> newVal = watcher.newVal();</div><div class="line">      <span class="keyword">const</span> oldVal = watcher.last;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (newVal !== oldVal &amp;&amp; !_.isNaN(newVal) &amp;&amp; !_.isNaN(oldVal)) &#123;</div><div class="line">        dirty = <span class="literal">true</span>;</div><div class="line">        watcher.listener(oldVal, newVal);</div><div class="line">        watcher.last = newVal;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再加入更新dom元素的逻辑，就变成了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">$digest() &#123;</div><div class="line">    <span class="keyword">const</span> bindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-bind]'</span>);</div><div class="line">    <span class="keyword">let</span> dirty = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (dirty) &#123;</div><div class="line">      dirty = <span class="literal">false</span>;</div><div class="line"></div><div class="line">      _.each(<span class="keyword">this</span>.$$watchers, (watcher) =&gt; &#123;</div><div class="line">        <span class="keyword">const</span> newVal = watcher.newVal();</div><div class="line">        <span class="keyword">const</span> oldVal = watcher.last;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (newVal !== oldVal &amp;&amp; !_.isNaN(newVal) &amp;&amp; !_.isNaN(oldVal)) &#123;</div><div class="line">          dirty = <span class="literal">true</span>;</div><div class="line">          watcher.listener(oldVal, newVal);</div><div class="line">          watcher.last = newVal;</div><div class="line"></div><div class="line">          _.each(bindList, (bind) =&gt; &#123;</div><div class="line">            <span class="keyword">const</span> modelName = bind.getAttribute(<span class="string">'ng-bind'</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (modelName === watcher.name) &#123;</div><div class="line">              <span class="keyword">if</span> (bind.tagName === <span class="string">'INPUT'</span>) &#123;</div><div class="line">                bind.value = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                bind.innerHTML = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h1 id="绑定到dom"><a href="#绑定到dom" class="headerlink" title="绑定到dom"></a>绑定到dom</h1><p>剩余的工作就是把一些dom事件绑定一下，这里简单的绑定一下click button和inputbox的change</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> clickBindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-click]'</span>);</div><div class="line"></div><div class="line">_.each(clickBindList, (clickBind) =&gt; &#123;</div><div class="line">  clickBind.onclick = () =&gt; &#123;</div><div class="line">    $scope[clickBind.getAttribute(<span class="string">'ng-click'</span>)]();</div><div class="line">    $scope.$digest();</div><div class="line">  &#125;;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> inputList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'input[ng-bind]'</span>);</div><div class="line"></div><div class="line">_.each(inputList, (input) =&gt; &#123;</div><div class="line">  input.addEventListener(<span class="string">'input'</span>, () =&gt; &#123;</div><div class="line">    $scope[input.getAttribute(<span class="string">'ng-bind'</span>)] = input.value;</div><div class="line">    $scope.$digest();</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'underscore'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scope</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>() &#123;</div><div class="line">    <span class="keyword">this</span>.$$watchers = [];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  $watch(name, exp, listener = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;) &#123;</div><div class="line">    <span class="keyword">this</span>.$$watchers.push(&#123;</div><div class="line">      name,</div><div class="line">      last: <span class="string">''</span>,</div><div class="line">      newVal: exp,</div><div class="line">      listener,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  $digest() &#123;</div><div class="line">    <span class="keyword">const</span> bindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-bind]'</span>);</div><div class="line">    <span class="keyword">let</span> dirty = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (dirty) &#123;</div><div class="line">      dirty = <span class="literal">false</span>;</div><div class="line"></div><div class="line">      _.each(<span class="keyword">this</span>.$$watchers, (watcher) =&gt; &#123;</div><div class="line">        <span class="keyword">const</span> newVal = watcher.newVal();</div><div class="line">        <span class="keyword">const</span> oldVal = watcher.last;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (newVal !== oldVal &amp;&amp; !_.isNaN(newVal) &amp;&amp; !_.isNaN(oldVal)) &#123;</div><div class="line">          dirty = <span class="literal">true</span>;</div><div class="line">          watcher.listener(oldVal, newVal);</div><div class="line">          watcher.last = newVal;</div><div class="line"></div><div class="line">          _.each(bindList, (bind) =&gt; &#123;</div><div class="line">            <span class="keyword">const</span> modelName = bind.getAttribute(<span class="string">'ng-bind'</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (modelName === watcher.name) &#123;</div><div class="line">              <span class="keyword">if</span> (bind.tagName === <span class="string">'INPUT'</span>) &#123;</div><div class="line">                bind.value = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                bind.innerHTML = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ngController</span>(<span class="params">controller</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> $scope = <span class="keyword">new</span> Scope();</div><div class="line"></div><div class="line">  controller($scope);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> clickBindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-click]'</span>);</div><div class="line"></div><div class="line">  _.each(clickBindList, (clickBind) =&gt; &#123;</div><div class="line">    clickBind.onclick = () =&gt; &#123;</div><div class="line">      $scope[clickBind.getAttribute(<span class="string">'ng-click'</span>)]();</div><div class="line">      $scope.$digest();</div><div class="line">    &#125;;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> inputList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'input[ng-bind]'</span>);</div><div class="line"></div><div class="line">  _.each(inputList, (input) =&gt; &#123;</div><div class="line">    input.addEventListener(<span class="string">'input'</span>, () =&gt; &#123;</div><div class="line">      $scope[input.getAttribute(<span class="string">'ng-bind'</span>)] = input.value;</div><div class="line">      $scope.$digest();</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> $scope) &#123;</div><div class="line">    <span class="keyword">if</span> (key != <span class="string">'$$watchers'</span> &amp;&amp; !_.isFunction($scope[key])) &#123;</div><div class="line">      $scope.$watch(key, () =&gt; $scope[key]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  $scope.$digest();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ngController(($scope) =&gt; &#123;</div><div class="line">  $scope.count = <span class="number">0</span>;</div><div class="line">  $scope.increment = () =&gt; &#123;</div><div class="line">    $scope.count++;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-binding/">data binding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/framework/">framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-defineObject-and-observable-watch" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/27/defineObject-and-observable-watch/" class="article-date">
  	<time datetime="2017-09-27T12:26:26.000Z" itemprop="datePublished">2017-09-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/27/defineObject-and-observable-watch/">Object.defineProperty</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty"></a>Object.defineProperty</h1><p>在js中我们用可以用这样几种方法定义属性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo.bar = <span class="string">'abc'</span>;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo[<span class="string">'bar'</span>] = <span class="string">'abc'</span>;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.defineProperty(foo, <span class="string">'bar'</span>, &#123;</div><div class="line">  value: <span class="string">'abc'</span>,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>defineProperty(<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="external">MDN链接</a>)这种方法，最麻烦，最强大.</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.defineProperty(obj, prop, descriptor)</div></pre></td></tr></table></figure>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><ul>
<li>obj: 需要被操作的目标对象</li>
<li>prop: 目标对象需要定义或修改的属性的名称</li>
<li>descriptor: 将被定义或修改的属性的描述符。</li>
</ul>
<h2 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h2><p>被传递给函数的对象</p>
<h2 id="descriptor"><a href="#descriptor" class="headerlink" title="descriptor"></a>descriptor</h2><p>之前列出来的比较简单的两种写法，是通过赋值来创建并显示在属性枚举中（<code>for...in</code>或<code>Object.keys</code>），可以被修改，也可以被删除。使用definePropery,可以控制这些：</p>
<ul>
<li>configurable: 这个值为true时，descriptor才可以被修改，同时这个property也能从obj上被删除。默认为false。</li>
<li>enumerable: 这个值为true时，才可以出现在<code>for...in</code>或者<code>Object.keys</code>中</li>
<li>value: property的值。默认undefined。</li>
<li>writable: 这个值为true时，propery才能被赋值运算符改变。默认false。</li>
<li>get/set: 就跟其他的getter/setter差不多，包括es6的getter/setter</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-on-vs-listenTo" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/10/on-vs-listenTo/" class="article-date">
  	<time datetime="2017-07-10T09:06:50.000Z" itemprop="datePublished">2017-07-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/10/on-vs-listenTo/">Backbone model- on vs listenTo</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>发现好久没有写blog了 要捡回来这个好习惯：）</p>
<p>今天遇到了一个bug，给一个全局的（不要吐槽,legacy code留下来的全局的东西没那么好消灭干净）添加了一个事件的callback，大致代码是这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">aGlobalModel.on(<span class="string">'a-event'</span>, () =&gt; &#123;</div><div class="line">  someView.doSomething();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>原因是，someView被remove的时候，忘了call gGlabal.off. Ok, 加上off逻辑当然不难，但是：</p>
<ol>
<li>直接call off会清理掉所有的handler。这坑爹货是全局的。。。。</li>
<li>可以指定off哪一个callback，所以这个callback会被传来传去。。比方说有很多处会remove的情况。on 并不是在someView里定义的。</li>
</ol>
<p>事实上，listenTo是一个更好的选择。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">someView.listenTo(aGlobalModel, <span class="string">'a-event'</span>, () =&gt; &#123;</div><div class="line">  <span class="comment">// ...code</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>当someView的remove被call到的时候 会自动的执行stopListening.</p>
<h3 id="看一下Backbone源码"><a href="#看一下Backbone源码" class="headerlink" title="看一下Backbone源码"></a>看一下Backbone源码</h3><ul>
<li>on</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Bind an event to a `callback` function. Passing `"all"` will bind</span></div><div class="line"><span class="comment">// the callback to all events fired.</span></div><div class="line">Events.on = <span class="function"><span class="keyword">function</span>(<span class="params">name, callback, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>._events = eventsApi(onApi, <span class="keyword">this</span>._events || &#123;&#125;, name, callback, &#123;</div><div class="line">    context: context,</div><div class="line">    ctx: <span class="keyword">this</span>,</div><div class="line">    listening: _listening</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (_listening) &#123;</div><div class="line">    <span class="keyword">var</span> listeners = <span class="keyword">this</span>._listeners || (<span class="keyword">this</span>._listeners = &#123;&#125;);</div><div class="line">    listeners[_listening.id] = _listening;</div><div class="line">    <span class="comment">// Allow the listening to use a counter, instead of tracking</span></div><div class="line">    <span class="comment">// callbacks for library interop</span></div><div class="line">    _listening.interop = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>listenTo</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Inversion-of-control versions of `on`. Tell *this* object to listen to</span></div><div class="line"><span class="comment">// an event in another object... keeping track of what it's listening to</span></div><div class="line"><span class="comment">// for easier unbinding later.</span></div><div class="line">Events.listenTo = <span class="function"><span class="keyword">function</span>(<span class="params">obj, name, callback</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!obj) <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  <span class="keyword">var</span> id = obj._listenId || (obj._listenId = _.uniqueId(<span class="string">'l'</span>));</div><div class="line">  <span class="keyword">var</span> listeningTo = <span class="keyword">this</span>._listeningTo || (<span class="keyword">this</span>._listeningTo = &#123;&#125;);</div><div class="line">  <span class="keyword">var</span> listening = _listening = listeningTo[id];</div><div class="line"></div><div class="line">  <span class="comment">// This object is not listening to any other events on `obj` yet.</span></div><div class="line">  <span class="comment">// Setup the necessary references to track the listening callbacks.</span></div><div class="line">  <span class="keyword">if</span> (!listening) &#123;</div><div class="line">    <span class="keyword">this</span>._listenId || (<span class="keyword">this</span>._listenId = _.uniqueId(<span class="string">'l'</span>));</div><div class="line">    listening = _listening = listeningTo[id] = <span class="keyword">new</span> Listening(<span class="keyword">this</span>, obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Bind callbacks on obj.</span></div><div class="line">  <span class="keyword">var</span> error = tryCatchOn(obj, name, callback, <span class="keyword">this</span>);</div><div class="line">  _listening = <span class="keyword">void</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</div><div class="line">  <span class="comment">// If the target obj is not Backbone.Events, track events manually.</span></div><div class="line">  <span class="keyword">if</span> (listening.interop) listening.on(name, callback);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>上述代码中用到的eventsApi,是标准的事件，回调迭代器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Iterates over the standard `event, callback` (as well as the fancy multiple</span></div><div class="line"><span class="comment">// space-separated events `"change blur", callback` and jQuery-style event</span></div><div class="line"><span class="comment">// maps `&#123;event: callback&#125;`).</span></div><div class="line"><span class="keyword">var</span> eventsApi = <span class="function"><span class="keyword">function</span>(<span class="params">iteratee, events, name, callback, opts</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> i = <span class="number">0</span>, names;</div><div class="line">  <span class="keyword">if</span> (name &amp;&amp; <span class="keyword">typeof</span> name === <span class="string">'object'</span>) &#123;</div><div class="line">    <span class="comment">// Handle event maps.</span></div><div class="line">    <span class="keyword">if</span> (callback !== <span class="keyword">void</span> <span class="number">0</span> &amp;&amp; <span class="string">'context'</span> <span class="keyword">in</span> opts &amp;&amp; opts.context === <span class="keyword">void</span> <span class="number">0</span>) opts.context = callback;</div><div class="line">    <span class="keyword">for</span> (names = _.keys(name); i &lt; names.length ; i++) &#123;</div><div class="line">      events = eventsApi(iteratee, events, names[i], name[names[i]], opts);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name &amp;&amp; eventSplitter.test(name)) &#123;</div><div class="line">    <span class="comment">// Handle space-separated event names by delegating them individually.</span></div><div class="line">    <span class="keyword">for</span> (names = name.split(eventSplitter); i &lt; names.length; i++) &#123;</div><div class="line">      events = iteratee(events, names[i], callback, opts);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Finally, standard events.</span></div><div class="line">    events = iteratee(events, name, callback, opts);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> events;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Backbone/">Backbone</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Events/">Events</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Framework/">Framework</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-es6-generator" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/24/es6-generator/" class="article-date">
  	<time datetime="2017-03-24T08:54:15.000Z" itemprop="datePublished">2017-03-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/24/es6-generator/">es6-generator</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>看babel官网上提供的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fibonacci = &#123;</div><div class="line">  [<span class="built_in">Symbol</span>.iterator]: <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> pre = <span class="number">0</span>, cur = <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">      <span class="keyword">var</span> temp = pre;</div><div class="line">      pre = cur;</div><div class="line">      cur += temp;</div><div class="line">      <span class="keyword">yield</span> cur;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> n <span class="keyword">of</span> fibonacci) &#123;</div><div class="line">  <span class="comment">// truncate the sequence at 1000</span></div><div class="line">  <span class="keyword">if</span> (n &gt; <span class="number">1000</span>)</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  <span class="built_in">console</span>.log(n);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在for…of…循环中，会调用迭代器对象的迭代器方法。之前那篇迭代器有提到过，但是这里的function*和普通的函数function不一样。如果是普通的函数，不管什么时候执行，得到的结果总是一样的（不考虑全局变量之类的干扰），或者说，和上一次无关。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6-ES2015/">ES6(ES2015)</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-dense-arrays" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/21/dense-arrays/" class="article-date">
  	<time datetime="2017-03-21T06:49:41.000Z" itemprop="datePublished">2017-03-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/21/dense-arrays/">Javascript中的稀疏数组 sparse arrays vs. 密集数组 dense arrays</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>大多数情况下，javascript中的数组是稀疏数组（其实就是k-v pairs），也就是说a[0], a[100]存在，但是a[1]到a[99]可能都不存在。</p>
<p>不存在，不是说存在但是是undefined,就是真正的不存在:如果用foreach访问并console.log，会发现根本没有这么一项，而不是输出一个undefined</p>
<p>实际上,JavaScript并没有常规的数组,所有的数组其实就是个对象,只不过会自动管理一些”数字”属性和length属性罢了.说的更直接一点,JavaScript中的数组根本没有索引,因为索引应该是数字,而JavaScript中数组的索引其实是字符串.arr[1]其实就是arr[“1”],给arr[“1000”] = 1,arr.length也会自动变为1001.这些表现的根本原因就是,JavaScript中的对象就是字符串到任意值的键值对.注意键只能是字符串</p>
<h3 id="sparse-arrays"><a href="#sparse-arrays" class="headerlink" title="sparse arrays"></a>sparse arrays</h3><ul>
<li>得到一个稀疏数组</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> sparseArr1 = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">3</span>);</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> sparseArr2 = [];</div><div class="line"></div><div class="line">sparseArr2[<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">sparseArr2[<span class="number">100</span>] = <span class="number">100</span>;</div></pre></td></tr></table></figure>
<ul>
<li>遍历稀疏数组，所有的“空隙”会被跳过<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> sparseArr2 = [];</div><div class="line"></div><div class="line">sparseArr2[<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">sparseArr2[<span class="number">100</span>] = <span class="number">100</span>;</div><div class="line"></div><div class="line">sparseArr2.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">index, val</span>) </span>&#123; <span class="built_in">console</span>.log(index); <span class="built_in">console</span>.log(val) &#125;) <span class="comment">// output: 1 0 100 100</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="dense-arrays"><a href="#dense-arrays" class="headerlink" title="dense arrays"></a>dense arrays</h3><ul>
<li>得到一个密集数组</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Array</span>(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>)</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> denseArr1 = <span class="built_in">Array</span>.apply(<span class="literal">null</span>, <span class="built_in">Array</span>(<span class="number">3</span>))；</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> denseArr2 = <span class="built_in">Array</span>.apply(<span class="literal">null</span>, <span class="built_in">Array</span>(<span class="number">3</span>)).map(<span class="built_in">Function</span>.prototype.call.bind(<span class="built_in">Number</span>))</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-destructuring" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/20/destructuring/" class="article-date">
  	<time datetime="2017-03-20T13:18:57.000Z" itemprop="datePublished">2017-03-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/20/destructuring/">ES6 - destructuring 整体析构赋值</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这个汉化——“ 整体析构赋值”——是抄的，我真的翻译不来。。。</p>
<h3 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h3><p>// list matching</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> [a, ,b] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</div><div class="line"></div><div class="line">a === <span class="number">1</span>;</div><div class="line">b === <span class="number">3</span>;</div></pre></td></tr></table></figure>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> obj = &#123; a: <span class="number">1</span>, b: <span class="number">2</span>, c: <span class="number">3</span>&#125;;</div><div class="line"><span class="keyword">const</span> &#123;a, c&#125; = obj;</div><div class="line"></div><div class="line">a === <span class="number">1</span>;</div><div class="line">c === <span class="number">3</span>;</div></pre></td></tr></table></figure>
<h3 id="function-parameters"><a href="#function-parameters" class="headerlink" title="function parameters"></a>function parameters</h3><ul>
<li>Can be used in parameter position</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params">&#123;name: x&#125;</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(x);</div><div class="line">&#125;</div><div class="line">g(&#123;name: <span class="number">5</span>&#125;)</div></pre></td></tr></table></figure>
<ul>
<li>Work with default args</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params">&#123;x, y, w = 10, h = 10&#125;</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> x + y + w + h;</div><div class="line">&#125;</div><div class="line">r(&#123;x:<span class="number">1</span>, y:<span class="number">2</span>&#125;) === <span class="number">23</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6-ES2015/">ES6(ES2015)</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iterators" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/16/iterators/" class="article-date">
  	<time datetime="2017-03-16T14:01:56.000Z" itemprop="datePublished">2017-03-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/16/iterators/">iterators &amp; for...of... es6迭代器</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="用for…in…一定要小心！！"><a href="#用for…in…一定要小心！！" class="headerlink" title="用for…in…一定要小心！！"></a>用for…in…一定要小心！！</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myArray = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> myArray) &#123; <span class="comment">// never do this!!</span></div><div class="line">  <span class="built_in">console</span>.log(myArray[index]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>index不是number而是string，说不定就让自己掉进 ‘2’ + 1 == ‘21’ 这样的bug里了</li>
<li>for-in还会作用于自定义属性（myArray.name这种）</li>
<li>有些时候顺序是随机的</li>
</ul>
<p><strong> 简而言之，for-in是为普通对象设计的，你可以遍历得到字符串类型的键，因此不适用于数组遍历 </strong></p>
<h3 id="forEach的局限"><a href="#forEach的局限" class="headerlink" title=".forEach的局限"></a>.forEach的局限</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">myArray.forEach(funciton(val) &#123;</div><div class="line">  <span class="built_in">console</span>.log(val);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>不能使用break语句中断循环，也不能使用return语句返回到外层函数</p>
<h3 id="for…of-in-es6"><a href="#for…of-in-es6" class="headerlink" title="for…of in es6"></a>for…of in es6</h3><ul>
<li>正确响应break, continue</li>
<li>避免for…in的缺点</li>
<li>除了Array, 还可以遍历String, map, set</li>
</ul>
<h3 id="迭代器对象"><a href="#迭代器对象" class="headerlink" title="迭代器对象"></a>迭代器对象</h3><p>for-of循环语句通过方法调用来遍历各种集合。数组、Maps对象、Sets对象以及其它在我们讨论的对象有一个共同点，它们都有一个迭代器方法。</p>
<p>你可以给任意类型的对象添加迭代器方法。</p>
<p>当你为对象添加myObject.toString()方法后，就可以将对象转化为字符串，同样地，当你向任意对象添加myObject<a href="">Symbol.iterator</a>方法，就可以遍历这个对象了</p>
<p>for-of循环首先调用集合的<a href="">Symbol.iterator</a>方法，紧接着返回一个新的迭代器对象。迭代器对象可以是任意具有.next()方法的对象；for-of循环将重复调用这个方法，每次循环调用一次</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6/">ES6</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-event-flow" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/15/event-flow/" class="article-date">
  	<time datetime="2017-03-15T02:23:36.000Z" itemprop="datePublished">2017-03-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/15/event-flow/">event flow</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="流-Flow-事件流-event-flow"><a href="#流-Flow-事件流-event-flow" class="headerlink" title="流 Flow - 事件流 event flow"></a>流 Flow - 事件流 event flow</h3><p>简单来说 流就是<strong>具有方向的数据</strong><br>事件流所描述的就是从页面中接受事件的顺序。</p>
<h3 id="事件冒泡"><a href="#事件冒泡" class="headerlink" title="事件冒泡"></a>事件冒泡</h3><p>事件冒泡即事件开始时，由最具体的元素接收（也就是事件发生所在的节点），然后逐级传播到较为不具体的节点</p>
<h3 id="事件捕获"><a href="#事件捕获" class="headerlink" title="事件捕获"></a>事件捕获</h3><p>当某个事件发生时，父元素应该更早接收到事件，具体元素则最后接收到事件</p>
<h3 id="addEventListener"><a href="#addEventListener" class="headerlink" title="addEventListener"></a>addEventListener</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">element.addEventListener(event, <span class="function"><span class="keyword">function</span>, <span class="title">useCapture</span>)</span></div></pre></td></tr></table></figure>
<p>第一个参数是需要绑定的事件，第二个参数是触发事件后要执行的函数。而第三个参数默认值是false，表示在事件冒泡的阶段调用事件处理函数，如果参数为true，则表示在事件捕获阶段调用处理函数</p>
<h3 id="DOM-事件流"><a href="#DOM-事件流" class="headerlink" title="DOM 事件流"></a>DOM 事件流</h3><ul>
<li><p>事件捕获阶段</p>
</li>
<li><p>处于目标阶段</p>
</li>
<li><p>事件冒泡阶段</p>
</li>
<li><p>阻止事件冒泡</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">event.stopPropagation()</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dom/">Dom</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 体力劳动者
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: ''
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>