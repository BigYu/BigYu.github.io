<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Yucong&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="No matter where we are going, it starts from where we are">
<meta property="og:type" content="website">
<meta property="og:title" content="Yucong's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Yucong's Blog">
<meta property="og:description" content="No matter where we are going, it starts from where we are">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yucong's Blog">
<meta name="twitter:description" content="No matter where we are going, it starts from where we are">
  
    <link rel="alternative" href="/atom.xml" title="Yucong&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/assets/img/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">体力劳动者</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">All</a></li>
				        
							<li><a href="/tags/Frameworks">Frameworks &amp; Libraries</a></li>
				        
							<li><a href="/tags/Javascript">Javascript</a></li>
				        
							<li><a href="/tags/css">Css</a></li>
				        
							<li><a href="/tags/随笔">随笔</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/BigYu" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/1798448072" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jin-yu-cong" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="mailto:jinyucong911@outlook.com" title="mail">mail</a>
					        
								<a class="facebook" target="_blank" href="https://www.facebook.com/profile.php?id=100007633386209" title="facebook">facebook</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/TinyJYC" title="twitter">twitter</a>
					        
						</div>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Backbone/" style="font-size: 10px;">Backbone</a> <a href="/tags/Dom/" style="font-size: 10px;">Dom</a> <a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/ES6-ES2015/" style="font-size: 12.5px;">ES6(ES2015)</a> <a href="/tags/Events/" style="font-size: 10px;">Events</a> <a href="/tags/Framework/" style="font-size: 10px;">Framework</a> <a href="/tags/Frameworks/" style="font-size: 15px;">Frameworks</a> <a href="/tags/Javascript/" style="font-size: 20px;">Javascript</a> <a href="/tags/Vue-js/" style="font-size: 10px;">Vue.js</a> <a href="/tags/css/" style="font-size: 12.5px;">css</a> <a href="/tags/data-binding/" style="font-size: 12.5px;">data binding</a> <a href="/tags/design-pattern/" style="font-size: 10px;">design pattern</a> <a href="/tags/framework/" style="font-size: 12.5px;">framework</a> <a href="/tags/functional-programming/" style="font-size: 10px;">functional programming</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/javascript/" style="font-size: 17.5px;">javascript</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
					</div>
				</section>
				

				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">No matter where we are going, it starts from where we are</div>
				</section>
				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">体力劳动者</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img lazy-src="/assets/img/avatar.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">体力劳动者</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">All</a></li>
		        
					<li><a href="/tags/Frameworks">Frameworks &amp; Libraries</a></li>
		        
					<li><a href="/tags/Javascript">Javascript</a></li>
		        
					<li><a href="/tags/css">Css</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/BigYu" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/1798448072" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jin-yu-cong" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="mailto:jinyucong911@outlook.com" title="mail">mail</a>
			        
						<a class="facebook" target="_blank" href="https://www.facebook.com/profile.php?id=100007633386209" title="facebook">facebook</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/TinyJYC" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-Functional-UI" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/25/Functional-UI/" class="article-date">
  	<time datetime="2017-12-25T01:29:02.000Z" itemprop="datePublished">2017-12-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/25/Functional-UI/">Functional approach to frontend development</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前端很难吗？"><a href="#前端很难吗？" class="headerlink" title="前端很难吗？"></a>前端很难吗？</h1><p>为什么想讲这个话题，因为咱们作为前端开发者，经常有被其他领域的工程师质疑：“你整天都在忙啥。不就是画个UI有那么难么？”当然我们可以找出很多例子来证明UI真的可以很难很高科技，比如说天猫那个魔术一般的navigation bar，但是我们加班真的在忙这些东西吗？我猜测绝大多数人跟我一样，头疼的task和bug都来自于无穷无尽的业务逻辑，表单，表格当中。所以我个人是很想赞同他们的质疑：“前端真的有那么难吗？”</p>
<p>很多技术都是出现的时候十分难，经过科学家和工程师们的不断努力，越来越强大，却反而越来越友好，比如说编程本身，功能已经无处不在，却早已不是那个只有尖端科学家才能学习的稀罕东西。web开发似乎是个例外，功能上的爆炸式增长的同时，javascript似乎变得越来越难以捉摸。</p>
<h1 id="田园时代"><a href="#田园时代" class="headerlink" title="田园时代"></a>田园时代</h1><p>西方的诗歌喜欢怀念田园时代，就是那个城市高楼手机汽车要啥没啥但是因为简单美好让大家觉得是遗失的天堂。古时候的Web开发也有这么一个时代，我们连JavaScript都没有，和我们提起前端脑子里“蹭”就冒出javascript可完全不一样。但我们确实可以完全不用JavaScript进行Web开发，比如经典的structs，spring，asp.net。这里我们姑且称那时为web开发的田园时代，简单，清晰，让人觉得舒服和美好。</p>
<p>虽然不是百分之百的场景还原，但是让我们花一分钟感受一下依赖ROR如何开发一个最基本的Web上的用户登录。用ruby是因为不用为一大堆花括号排版ppt，请大家不要关注语言谢谢。</p>
<p>这是很纯粹的一个MVC pattern的server side rendering,Model和Controller都是在服务器上运行的代码，View是在server端渲染好，再以html的形式返回给浏览器呈现给用户。Model的作用 ，是用来管理数据。这个例子中，我们建了一张用户表，有name和password两个字段。当然实际项目如果这么存password后果比较严重，大家不要模仿，User Model描述了我们需要校验name存在以及一个大写的变换。 View的作用，是把model用人类可交互的方式在网页上display给用户，比如绘制了一个form，并且将model中的相应字段填进去并且指定了表单提交的地址，我们在这里省略了关于样式和页面上的细节组件。 Controller用来handler business logic。这个例子里，我们只完成了认证通过的部分：将id计入session，redirect到landing url。虽然这是很业余的一种做法，只是为了demo方便，但是实际项目中也无非是用真实的持久化登陆状态的过程替换，完整的计算出一个user info并且交给landing view来渲染。(下一页)没有JavaScript，我们完成这样一个登陆的web页面。</p>
<p>建表(当然production中这么建表被fire了后果自负)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> (</div><div class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) NNOT <span class="literal">NULL</span> auto_increment,</div><div class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</div><div class="line">  <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>model</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></div><div class="line">  validates <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  before_create <span class="keyword">do</span></div><div class="line">    <span class="keyword">self</span>.name = login.capitalize <span class="keyword">if</span> name.blank?</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>view</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;%=<span class="ruby"> form_tag(<span class="string">"/login"</span>, <span class="symbol">method:</span> <span class="string">"post"</span>) <span class="keyword">do</span> </span>%&gt;</div><div class="line">  &lt;%=<span class="ruby"> text_field_tag(<span class="symbol">:name</span>) </span>%&gt;</div><div class="line">  &lt;%=<span class="ruby"> password_field_tag(<span class="symbol">:password</span>) </span>%&gt;</div><div class="line">  &lt;%=<span class="ruby"> submit_tag(<span class="string">"Search"</span>) </span>%&gt;</div><div class="line">&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;</div></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;h1&gt;Welcome&lt;/h1&gt;</div><div class="line">&lt;h3&gt;Hello: &lt;%=<span class="ruby"> user.name </span>%&gt;&lt;/h3&gt;</div></pre></td></tr></table></figure>
<p>controller</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginsController</span> &lt; ApplicationController</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span></span></div><div class="line">    <span class="keyword">if</span> user = User.authenticate(params[<span class="symbol">:username</span>], params[<span class="symbol">:password</span>])</div><div class="line">      session[<span class="symbol">:current_user_id</span>] = user.id</div><div class="line">      redirect_to landing_url</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h2 id="UI和业务逻辑没有太多耦合"><a href="#UI和业务逻辑没有太多耦合" class="headerlink" title="UI和业务逻辑没有太多耦合"></a>UI和业务逻辑没有太多耦合</h2><p>这就是我们所描述的田园时代，简单清晰。展示层，或者我们所说的View和业务逻辑，就是那段controller代码，只是通过model的字段定义有数据接口上的约定，没有其余的耦合。Controller处理业务逻辑，操作我们的model。View用来展示model。想象我们现在不用ejs作为模板引擎了，比如说用pug，controller基本不用啥改动。同样的，现在我们把db用mongodb替代mysql（事实上，我推荐个人小项目这么干），view基本不用改。即使业务变复杂，这个原则不会改变。</p>
<h2 id="换成knockout呢。。。"><a href="#换成knockout呢。。。" class="headerlink" title="换成knockout呢。。。"></a>换成knockout呢。。。</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-bind</span>=<span class="string">"css: &#123; profitWarning: currentProfit() &lt; 0, majorHighlight: isSevere &#125;"</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="工业文明：欢迎来到JavaScript和SPA的世界"><a href="#工业文明：欢迎来到JavaScript和SPA的世界" class="headerlink" title="工业文明：欢迎来到JavaScript和SPA的世界"></a>工业文明：欢迎来到JavaScript和SPA的世界</h1><p>但是为什么我们现在都move到了JavaScript的世界，都采用SPA来开发？人们做生意都不想做赔本生意，这里也是，我们为了好处和解决问题而来。</p>
<p>首先，服务端渲染的performance很差。我们需要在服务端操作model，渲染出整个页面，然后以html的形式返回给前端，效果很差。哪怕计算的结果是刚才的login form下面只多了一行字：“对不起，您的密码有误”<br>另外，重画整个页面除了很差的perf，对用户体验的副作用也是很大的，原来focus在密码框里的光标会lose focus，重新填写还要再点一下。就像刚才Shixin讲的，这是一个ui friction<br>此外，没有ajax，我们无法做到异步操作。我们等待密码验证的时候什么事都干不了。<br>从开发者的角度，在浏览器上debug和连上服务器debug，体验不可同日而语。比如说，对于lsr，连上prod server去打断点不会是一个美好的回忆。</p>
<ul>
<li>Server side rendering has poor performance</li>
<li>Whole page redrawing has bad user experience</li>
<li>Cannot do asynchronous tasks</li>
<li>Difficult to debug on servers</li>
</ul>
<h2 id="代价"><a href="#代价" class="headerlink" title="代价"></a>代价</h2><p>就像现代文明会带来环境污染一样，我们付出了代价。</p>
<p>一个严重的问题，就是UI和业务逻辑开始深度耦合。现在我们不黑ko了，这是angular官网上的例子当然angular是一个优秀的框架，涉及到了和今天的topic无关的设计哲学，咱们这里就不讨论了。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"ctrl-as-exmpl"</span> <span class="attr">ng-controller</span>=<span class="string">"SettingsController1 as settings"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ng-model</span>=<span class="string">"settings.name"</span>/&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">ng-click</span>=<span class="string">"settings.greet()"</span>&gt;</span>greet<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line">  Contact:</div><div class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">ng-repeat</span>=<span class="string">"contact in settings.contacts"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">select</span> <span class="attr">ng-model</span>=<span class="string">"contact.type"</span> <span class="attr">aria-label</span>=<span class="string">"Contact method"</span> <span class="attr">id</span>=<span class="string">"select_&#123;&#123;$index&#125;&#125;"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">option</span>&gt;</span>phone<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">option</span>&gt;</span>email<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ng-model</span>=<span class="string">"contact.value"</span> <span class="attr">aria-labelledby</span>=<span class="string">"select_&#123;&#123;$index&#125;&#125;"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">ng-click</span>=<span class="string">"settings.clearContact(contact)"</span>&gt;</span>clear<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">ng-click</span>=<span class="string">"settings.removeContact(contact)"</span> <span class="attr">aria-label</span>=<span class="string">"Remove"</span>&gt;</span>X<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">ng-click</span>=<span class="string">"settings.addContact()"</span>&gt;</span>add<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="debug-更难诊断"><a href="#debug-更难诊断" class="headerlink" title="debug: 更难诊断"></a>debug: 更难诊断</h3><p>这样的第一个后果，出现在deBug上。确实，用浏览器比起连上server，打断点的体验好一些。但是打几个断点？在哪打断点？传统的MVC，debug很难，但是，找到rootcause很简单。刚才的例子啊，名字变到hello之前了，那我们知道在view里出问题了。发现那么不是我们想要的，ok看下controll里findUserById的调用处打断点。现在混合之后，页面上的元素组织甚至在和model或者viewmodel里数据的拓扑结构绑定，我们无从查起。更不用说，所有data binding为基础的框架，我们更多的看到这样的error message所以，来到浏览器上，我们开始debug不难了，但是，还是得加班</p>
<h3 id="扩展：难以refactor和修改设计"><a href="#扩展：难以refactor和修改设计" class="headerlink" title="扩展：难以refactor和修改设计"></a>扩展：难以refactor和修改设计</h3><p>第二个问题，就是我们的修改，变麻烦了。讲这样一个故事啊，我们的campaign creation，也就是让advertiser创建campaign流程中，需要用户设置自己campaign的budget。这个要求即使对于初学者也是小菜一碟。</p>
<p>我们的campaign creation分为4个大的步骤。PM想到了，他在中间步骤的时候会重新考量自己的业务，这样在最后一步，他经常发现在第一步设置的budget需要修改。当然，依然还有很多advertiser对于自己有多少钱是心中有数的，所以想在第一步设置好。所以，我们解决ui friction的办法就是，两边都放上。</p>
<p>对于以前的模式，这不是问题，在最后一步view里面加一个budget input，把model填进去，搞定。如果你在用什么java ant tomcat，那就敲一下f5然后出去吃夜宵。</p>
<p>现在的话，嗯，比方这样一个问题啊：</p>
<p>如果我们让这两个budget control是一个instance:因为每一步的next和back button都会validate当前step所有的form,那么实际上，第一步和第四步的都执行了自己步骤以外的validation，这导致了很多bug；如果让他们是不同的instance，需要构造两次不说，其他受budget影响的component都需要监听或者分辨来自不同budget control的事件，或者判断传入的instance是不是当前想要的。数据和validation同步也是可能导致问题的。</p>
<p>我们这个讨论还没结束呢，另一个crew开始找我们集成shared budget。业务上来说，几个campaign可以用同一个shared budget；工程上来说，就是我们原来写的budget的control成为了新的budget panel的子组件。在viewmodel里，hierarchy同时影响了页面上的布局和逻辑里的关系，牵一发而动全身。</p>
<p>另外一方面，如果将来我们有更多的选项，需要用dropdown替换radio button，显然这种UI和业务逻辑耦合的做法会带来更多的困扰</p>
<h3 id="新问题：引入异步带来的坑"><a href="#新问题：引入异步带来的坑" class="headerlink" title="新问题：引入异步带来的坑"></a>新问题：引入异步带来的坑</h3><p>再就是concurency。新加入的功能引来了新的问题。</p>
<p>我们的render和destroy方法都是同步的。因为lazy loading的需求，我们需要在render的时候再加载一个第三方库，加载成功之后会创建一系列新的实体在其子节点上。destroy的时候，需要讲他们一一销毁：这时，一个很容易出bug的问题诞生了：你怎么知道destroy的时候render及其异步操作已经全部完成。稍不小心就会让程序进入无法预测的异常状态。</p>
<ol>
<li>改框架，render和destroy都支持promise。<ul>
<li>好主意，加油（微笑）争取明年release（doge）</li>
</ul>
</li>
<li>加全局flag<ul>
<li>我们确实很多时候是怎么干的。</li>
<li>异步之后又fork出新的异步task怎么办</li>
<li>你怎么能保证线程安全？怎么能保证flag不被修改？如果之后的业务告诉你确实要修改flag怎么办？比如说，有两个同时进行的lazy loading。掀桌。</li>
</ul>
</li>
</ol>
<h1 id="文艺复兴"><a href="#文艺复兴" class="headerlink" title="文艺复兴"></a>文艺复兴</h1><p>我们付出的这些代价，就是可以讨论的可以改进的空间。我们想变得更好。原来简单，清晰。我们要重新变简单，变清晰。</p>
<p>那么，当时move到JavaScript SPA的时候，不就是把server sider rendering换成client side rendering嘛，其他的逻辑组织一切都不变，完全平移到client side。或者说用javascript强行写一个ror或者asp.net搁浏览器里跑，可行吗？</p>
<p>可行倒是可行，但是频繁的重画整个dom tree，依然让perf和体验不理想，可以归结为ui friction。</p>
<p>那为什么现在我们又能重新讨论这个话题了呢？上周关于react的分享中，我们知道了virtual dom这个概念。这个想法太赞了，我们在code里不管怎样重新render都没有关系，多了一层来帮我们计算delta来作partial rendering，即使我们让数据一圈一圈转起来，都不用担心perf 都不用担心ux了。<br>另一方面，现在的UI，组件话已经越来愈好，对于很多局部的小控件，其实啊，重画是完全可以接受的，并不是ui friction，比方说，你就是一个小小的date picker之类的。<br>好了，现在我们可以回头找一下那一些被迫放弃的田园时代的美好吧。不过千万不要忘了，异步的问题是新带来的，我们还需要解决</p>
<h2 id="如何思考？"><a href="#如何思考？" class="headerlink" title="如何思考？"></a>如何思考？</h2><p>既然已经打出了文艺复兴的旗号啊，接下来咱们就会在把那些以前落了灰的东西翻出来，收拾收拾里面精华的思想，然后总结一套 让我们的开发重新变简单 的思路和方法。</p>
<p>实际上react分享的时候，已经有这样的问题被提出来，如果我把view model中引起问题的那个数据流方向干掉，是不是就可以实现跟react类似的功能。perf问题？没关系，也有很好的开源的virtual dom技术。</p>
<p>why not？没错，我们今天的topic，不需要任何新的framework也好 library也好。当然，有些跟我熟一点的知道我是某些新东西的粉丝。放心，我不是来传销他们的。如果你有听过启发我讲这个topic的那些新东西，希望你能理解 原来是这个原因 我才喜欢他 如果你不知道那是啥 更好 希望你能知道 啊 原来老的代码里 还能这样想。</p>
<h3 id="Business-requirements-gt-mathematic-problems-gt-code"><a href="#Business-requirements-gt-mathematic-problems-gt-code" class="headerlink" title="Business requirements -&gt; mathematic problems -&gt; code"></a>Business requirements -&gt; mathematic problems -&gt; code</h3><p>我们上班是来干嘛的？</p>
<p>我们是来解决问题的 然后用解决问题的能力兑换成薪水</p>
<p>程序员怎么解决问题？</p>
<p>我们把实际的业务抽象成数学问题 然后把解决这个数学问题的方案用代码写出来</p>
<h2 id="从田园controller开始"><a href="#从田园controller开始" class="headerlink" title="从田园controller开始"></a>从田园controller开始</h2><p>重温一下什么是controller：它是用来handle业务逻辑的，具体的，干了两件事：第一，操作model，用时髦的说法，这句话很重要：执行model的状态转移。第二，根据业务，把相应的model交给相应的view，进行渲染</p>
<h3 id="我们的业务逻辑"><a href="#我们的业务逻辑" class="headerlink" title="我们的业务逻辑"></a>我们的业务逻辑</h3><ul>
<li>描述model的状态转移：实际上就是根据一些条件，对model执行了一个函数，得到了一个新的model</li>
<li>重复一遍：执行了一个函数，得到了一个新的model：而不是执行了一条命令，修改了model。</li>
<li>为了让问题更简单，我们做一个尝试，让刚才说的“一些条件”全部由操作时的parameter来表示，其他因素要么放进去，要么被忽略。</li>
<li>我们还想要更进一步的简单和清晰。OK，model里有字段，还有描述model变换的方法。我们不要，我们只需要一个最最简单的数据结构，比如说，简单到就是一个简单的plain object。我们给它一个更准确描述这个plain object的名字： state</li>
<li>对于parameters 推广到普遍适用的情况，我们给他的名字叫 action，动作，来自哪里的动作？我不关心</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">state_next  =  r(state, actions)</div></pre></td></tr></table></figure>
<h3 id="我们的UI"><a href="#我们的UI" class="headerlink" title="我们的UI"></a>我们的UI</h3><p>再来看controller的另一个任务：把相应的model交给相应的view，进行渲染。</p>
<ul>
<li>What is a view?<ul>
<li>To display model</li>
</ul>
</li>
</ul>
<p>也就是说，View是什么？View就是把model扔在屏幕上，使其可以和用户交互的一种映射。回忆一下高中数学，把model可能的状态看成定义域，UI所有可能的显示看成值域，这是什么？一个函数</p>
<p>跟之前一样的解释：model拓广到states 我们得到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UI = f(state)</div></pre></td></tr></table></figure>
<p>是的 UI只听state的</p>
<p>你想说 我的页面，要在晚上10：00到早上8：00把页面弄成适合夜间的尿黄色。OK，请在state里描述时间。<br>我的页面，在中国用高德map，在美国用google map。OK，请在state里描述location。</p>
<p>UI就干你改干的事，清清楚楚。</p>
<p>state怎么这么累？f说，我不知道，你问r去</p>
<p>这就是今天我想阐述的核心</p>
<p><strong>敲黑板重点</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UI = f(r(state, action))</div></pre></td></tr></table></figure>
<h1 id="UI-f-r-state-action-欢迎来到函数的世界"><a href="#UI-f-r-state-action-欢迎来到函数的世界" class="headerlink" title="UI = f(r(state, action)): 欢迎来到函数的世界"></a>UI = f(r(state, action)): 欢迎来到函数的世界</h1><h2 id="我们的工作"><a href="#我们的工作" class="headerlink" title="我们的工作"></a>我们的工作</h2><ul>
<li>怎么描述一个时间点上静态的状态？这是state的问题</li>
<li>怎么描述发生的一切和其他实体，比如用户的交互？这是action</li>
<li>怎么让state和action相互作用，完成业务逻辑的要求？找一个合适的r。我会忍住不说我最喜欢的那个很新的r，我后面会证明，你们正在用的那些被嫌弃的老技术，也可以是很好的r</li>
<li>怎么在真正的页面上让state说人话？找一个合适的f，同样的，别看不起你们现在用的。</li>
</ul>
<p>更进一步解释我给出的这个式子。</p>
<p>第一件事情：前面已有说明，f和r就是数学意义上真正的函数，不是我们平时干的写作function用成command或这procedure的那些假冒伪劣产品。在编程上 我们称为纯函数。<br>第二件事情：只是再强调一遍，我不是来推销某个framework的，这种pattern，对所有的中立。<br>第三件事情：这种pattern，实际上已经解决了开始提出的一个重要的问题：UI和business logic耦合</p>
<h2 id="我们的数学基础"><a href="#我们的数学基础" class="headerlink" title="我们的数学基础"></a>我们的数学基础</h2><h3 id="范畴论-Category-theory"><a href="#范畴论-Category-theory" class="headerlink" title="范畴论 Category theory"></a>范畴论 Category theory</h3><p>首先是范畴论：将这些概念形式化成一组组的“物件”及“态射”</p>
<ul>
<li>解释了为什么pure function对干扰免疫，没有副作用</li>
<li>思考问题的时候，一定注意把pure function理解成pipe，而不是execute，重点！pipe！</li>
</ul>
<p>这就是函数式编程最基本的模型：函数就是箭头，值就是点（后面λ演算可以更丧（gan）心（de）病（piao）狂（liang）的指出值也是函数），除了两个点，这就是一个纯粹的数学模型，不会和任何其他的点或者箭头发生交互。<br>这个箭头不会吃掉它出发的点，不会改变它到达的点，它就是像一跟管道一样。<br>没错，一定要把函数理解成管道，不要理解成命令！我们的思维在这里转变。</p>
<h3 id="λ演算-λ-calculus"><a href="#λ演算-λ-calculus" class="headerlink" title="λ演算 λ calculus"></a>λ演算 λ calculus</h3><p>λ-terms（解释了为什么“函数是一等公民”）形象的说，就解释了函数，不仅是箭头，也可以是点。函数本身就是一种值的类型。<br>evaluation（解释了柯里化的数学原理，解释了FP对于异步和并行的优势，启发我们不要用传统的考虑“值”的思路（call by value）去理解而是call by name）<br>λ表达式只允许一个参数，柯里化可多个。<br>函数应用可以把函数整体代入，不是先要求值：这就是我们天天写的callback啊</p>
<h2 id="我们的工具"><a href="#我们的工具" class="headerlink" title="我们的工具"></a>我们的工具</h2><p><strong>纯函数 pure functions</strong></p>
<p>重温一下pure funciton的概念，之前react的分享里已经提到过的</p>
<p>两个要求：第一：输入确定，则输出确定。第二：没有副作用，或者说，它只能干一件事请，就是输出一个值，其他什么改一个全局变量啊全都不行。</p>
<p>换句话说，pure function就是纯数学意义上的函数，编程上是stateless function，没有internal state。</p>
<h3 id="我们建造新大厦的砖块"><a href="#我们建造新大厦的砖块" class="headerlink" title="我们建造新大厦的砖块"></a>我们建造新大厦的砖块</h3><p>在这个pattern中，pure function就是我们编程的砖块。为什么选择这个当砖块？因为它最简单，也最容易复用。</p>
<p>首先，它完全对这样一大类bug免疫，就是一堆人在改同一个可变的东西，什么out of sync或者inconsistent的问题。因为每块砖只关心自己的输入。<br>另外因为这个特性，它一定是并行编程的很好的候选方案。<br>第三，它完全不关注自己受谁的影响，自己会影响谁。在哪都一样，很容易的就搬来搬去。</p>
<p>我猜有人会用随机数生成的问题来challenge。没问题，只需要知道随机数需要seed就好了。</p>
<p>当然，等真的写code的时候，我们想的一定是怎么解决实际问题，而不是怎么套用design pattern，我们想的是怎么用pure function的思想提高我们思考的效率，而不是绞尽脑汁套pure function来降低我们思考的效率，be smart</p>
<blockquote>
<p>Javascript并不是一门非常适合函数式编程的语言</p>
</blockquote>
<h2 id="我们的动机"><a href="#我们的动机" class="headerlink" title="我们的动机"></a>我们的动机</h2><ul>
<li>We want UI to be predicable</li>
<li>We want states transforming be predicable</li>
<li>Reusability, Flexibility and Extensibility</li>
</ul>
<h2 id="我们的做法"><a href="#我们的做法" class="headerlink" title="我们的做法"></a>我们的做法</h2><h3 id="Immutable"><a href="#Immutable" class="headerlink" title="Immutable"></a>Immutable</h3><p>不推荐的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">function selectionProjectionHandler(state, config, model) &#123;</div><div class="line">  if (config.selectable) &#123;</div><div class="line">    // ...</div><div class="line">  &#125; else &#123;</div><div class="line">    state.errorCode = 'error_unselectable’;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>推荐的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">function selectionProjectionHandler(state, config, model) &#123;</div><div class="line">  if (config.selectable) &#123;</div><div class="line">    return /* compose new state with item selection */</div><div class="line">  &#125;</div><div class="line">  // Immutable</div><div class="line">  return Object.assign(&#123;&#125;, state, &#123;</div><div class="line">    errorCode: 'error_unselectable’,</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实很简单 别改 返回一个新的</p>
<p>当然这个例子说明了一个问题是 如果你的目标是学习函数式编程 显然JavaScript不是一个合适的选择 这里的语法看起来不太直观 甚至可以说 是一个work around： 因为那个新的对象 其实就是这个空的花括号修饰出来的 没错 这不是immutable 我们产生了修改这个空object的副作用 强调一遍 我想讲的是怎么借助这些思想让我们开发变简单</p>
<p>而immutablejs这个库的作用 就是强制copy on write 对于map array set这些基础的结构做了封装</p>
<p>recap一个pure function： 干且仅干一件事情 接受一个输入 给一个输出</p>
<h3 id="Partial-applying"><a href="#Partial-applying" class="headerlink" title="Partial applying"></a>Partial applying</h3><p>偏函数解决这样的问题：如果我们有函数是多个参数的，我们希望能固定其中某几个参数的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">status, context, message</span>) </span>&#123;</div><div class="line">  <span class="comment">// fancy logging code here</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params">context, message</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> log(<span class="string">'info'</span>, context, message);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">dbInfo</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> info(<span class="string">'db'</span>, message);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Currying-柯里化"><a href="#Currying-柯里化" class="headerlink" title="Currying 柯里化"></a>Currying 柯里化</h3><p>下面来讲柯里化 因为λ演算表现成code 最纯净的函数定义是一个参数进去 一个参数出来 但是我们实际业务很容易描述成具有多个参数的情形 所以我们需要柯里化 只提供一个参数 其他的参数作为这个函数的“环境”来创建，来回归原始</p>
<p>大家回想一下自己备战高考的岁月啊 数学里函数的部分占了大头对吧 大家重温一下只有一个参数的题的难度 和有多个参数的题的难度 应该就有一个感性的认识了 现在我们做项目 不就是两步：先把实际问题数学化 再把数学解答代码化？好 想展开一个话题 随便google一篇文章都比我这讲得好 就不浪费时间了</p>
<p>柯里化是把接受多个参数的函数变换成接受一个单一参数（最初函数的第一个参数）的函数，并且返回接受余下的参数而且返回结果的新函数的技术。指的是将一个具有多个参数的函数，转换成能够通过一系列的函数链式调用，其中每一个函数都只有一个参数</p>
<p>我们还是拿log这个例子来说明</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">function log(status) &#123;</div><div class="line">  return function(context) &#123;</div><div class="line">    return function(message) &#123;</div><div class="line">      // fancy logging code here</div><div class="line">    &#125;;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line">const info = log('info’);</div><div class="line">info('db-context')('message');</div><div class="line">const dbInfo = info('db'); // create a new function again</div><div class="line">dbInfo('something happened’);</div><div class="line">log('other level')('some context')('a message');</div></pre></td></tr></table></figure>
<p>这就是柯里化 其实没那么玄乎 我们把一个关注三个参数的问题 变成了三个分别只有一个参数的函数的链式调用</p>
<p>我们想要创建之前的info函数 就把status=info理解成创建这个新函数需要的环境</p>
<p>请看 这很生动的说明了函数作为一等公民 充当返回值这个角色 现在我们想打一条log 就是调用这个新函数</p>
<p>或者说 我们还想把dbInfo这个新函数创建出来 道理也是一样的 不过这里我们又可以强调一下了 一定要是纯函数 如果不是 比如说dbInfo调用的时候有可能有对info甚至log产生副作用 这整个体系就崩塌了</p>
<p>可以说 柯里化就是这样一个神奇的工具 我们几乎可以只依靠它 又简洁又优雅的的解决特性与共性的问题 给予我们代码良好的复用性 灵活性 扩展性 理解起来 我们只需要牢牢记住 函数是一等公民</p>
<h3 id="Function-compose"><a href="#Function-compose" class="headerlink" title="Function compose"></a>Function compose</h3><p>我们来复习高中知识 啥叫函数组合？很简单 f(x)是函数 那么 f(g(x))就是函数组合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UI = f(r(state, action))</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> compose = <span class="function"><span class="keyword">function</span>(<span class="params">f, g</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> f(g(x));</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="我们的收获"><a href="#我们的收获" class="headerlink" title="我们的收获"></a>我们的收获</h2><ol>
<li>Reasonable</li>
</ol>
<p>很多人相信使用纯函数最大的好处是引用透明性（referential transparency）。如果一段代码可以替换成它执行所得的结果，而且是在不改变整个程序行为的前提下替换的，那么我们就说这段代码是引用透明的。<br>由于纯函数总是能够根据相同的输入返回相同的输出，所以它们就能够保证总是返回同一个结果，这也就保证了引用透明性。</p>
<ol>
<li>Cacheable</li>
</ol>
<p>首先，纯函数总能够根据输入来做缓存。实现缓存的一种典型方式是 memoize 技术</p>
<ul>
<li>值得注意的一点是，可以通过延迟执行的方式把不纯的函数转换为纯函数：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> pureHttpCall = memoize(<span class="function"><span class="keyword">function</span>(<span class="params">url, params</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> $.getJSON(url, params); &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ol>
<li>Portable / Self-Documenting</li>
</ol>
<p>纯函数是完全自给自足的，它需要的所有东西都能轻易获得。</p>
<p>在 JavaScript 的设定中，可移植性可以意味着把函数序列化（serializing）并通过 socket 发送。也可以意味着代码能够在 web workers 中运行。总之，可移植性是一个非常强大的特性。<br>命令式编程中“典型”的方法和过程都深深地根植于它们所在的环境中，通过状态、依赖和有效作用（available effects）达成；纯函数与此相反，它与环境无关，只要我们愿意，可以在任何地方运行它。<br>你上一次把某个类方法拷贝到新的应用中是什么时候？我最喜欢的名言之一是 Erlang 语言的作者 Joe Armstrong 说的这句话：“面向对象语言的问题是，它们永远都要随身携带那些隐式的环境。你只需要一个香蕉，但却得到一个拿着香蕉的大猩猩…以及整个丛林”。</p>
<ol>
<li>Testable</li>
</ol>
<p>纯函数让测试更加容易。我们不需要伪造一个“真实的”支付网关，或者每一次测试之前都要配置、之后都要断言状态（assert the state）。只需简单地给函数一个输入，然后断言输出就好了。</p>
<ol>
<li>Parallel</li>
</ol>
<p>最后一点，也是决定性的一点：我们可以并行运行任意纯函数。因为纯函数根本不需要访问共享的内存，而且根据其定义，纯函数也不会因副作用而进入竞争态（race condition）</p>
<h1 id="One-more-thing"><a href="#One-more-thing" class="headerlink" title="One more thing"></a>One more thing</h1><h2 id="Flux-pattern"><a href="#Flux-pattern" class="headerlink" title="Flux pattern"></a>Flux pattern</h2><ul>
<li>View: representation layer. Controller views.</li>
<li>Action: raise actions from representational layer.</li>
<li>Dispatcher: receive actions and invoke callbacks.</li>
<li>Store: respond to dispatched actions.</li>
</ul>
<h2 id="Views-controllers-pattern"><a href="#Views-controllers-pattern" class="headerlink" title="Views controllers pattern"></a>Views controllers pattern</h2><ul>
<li>Separate controllers(container components) and views(representational components)</li>
</ul>
<h1 id="几个肯定会被问到的问题："><a href="#几个肯定会被问到的问题：" class="headerlink" title="几个肯定会被问到的问题："></a>几个肯定会被问到的问题：</h1><p><strong>Q: In big team co-work, how to break projects down?</strong></p>
<p>(如果我们用函数式思考，一切非常自然)</p>
<p>回答这个问题，我建议大家先来这样思考我们的项目，想象成一个表格，或者数据库表，也就是一个二维的矩阵，一个维度是不同的业务实体，在这里就是不同种类的campaign；另一个维度与它垂直，就像是auth, i18n, theming，routing等等，你每一行代码的作用，就都可以用一个向量来表示：我这一行，是处理DSA的i18n。那么两种思考问题的方式其实就是一个地方不一样：把哪个维度看成行，把哪个维度看成列。</p>
<p>传统的方法是根据业务来思考的。而这里推荐的另一个看问题的角度，是通过可扩展性，可维护性，（说人话：呼应标题，让前端开发变简单）的方面来思考。这和数据库很类似：行扩展很简单，一条SQL语句即可，列扩展相对麻烦。所以我们用middleware来描述我们的列:<br>一方面，借助柯里化，当我们需要扩展列（增加新的middleware）时，代价不那么大<br>另一方面，当我们增加业务实体时（这是我们的主要工作，除了架构师）进行简单的行扩展</p>
<p>比方说 auth, i18n, theming，routing等等作为middleware避免了大量重复代码。我们平时在处理这些逻辑的时候，就算不是copy paste，互相之间的差别也不大，基本上是配置上的差别。</p>
<p>那么我们会问这样一个问题，如果我要在我们的项目中加入一个新的entity，举个例子，我们已经有了几种campaign，search campaign，shopping campaign等等，现在我们又要加入DSA campaign.</p>
<p>传统的做法是加入一个DSACampaignController,里面包含CRUD的actions，然后创建相应的View，templates，和campaignMT，adInsight MT integrate之后release，当然这些和之前其他campaign的code会有很多重复但是我们似乎也能接受（其实是习惯了）</p>
<p>按照上面的做法，是不是说我要在auth里添加一点DSA的配置，i18n里添加几个DSA的规则，说起来不用写完整的重复的controller啊之类的，但是这种散弹式的修改真的不是团队协作的毒药吗？怎么不像上面说的“行扩展”那样简单啊？<br>回答：</p>
<ol>
<li>设计出声明式编程的接口很难吗？设计出集中配置项的语法糖很难吗？最最简单的，有一个middleware来派送config给不同的middleware总能做到吧。</li>
<li>flux pattern中一个重要的角色是dispatcher，具体的应用中不同框架有不同的设计，但是功能都是：把不同的action分发到不同的store或者store里的不同字段。比方说一个简单的设计，不就是hash map吗？添加新的DSA campaign type，可以设计成为为这个新的entity action添加新的reducer（就是前面讲到的r的组件，或新的一组reducer）</li>
</ol>
<p>当然由此还会有一个问题：如果维度不够用怎么办？拿业务上说就是：我们的business entity不一定是扁平的结构，就比如说，我们有不同type的campaign，这是一层，不同type的adgroup，ads， keywords等等，然后campaign,ads,keywords这些又是拿到一层考虑：</p>
<p>flatten：可能很多时候我们并不需要关系这些业务上的树形关系，共性和特性就是柯里化中的小技巧了。<br>数学上的分形，或者结合micro service的理念，通过子APP的方式来完成。</p>
<p>可能还是有点抽象，还是举projection grid中的例子吧：</p>
<p>不同场景下，datasource的不同，toolbar构造的不同，只体现在配置不同上。<br>功能上的扩展，对于开发者来说，考虑两件事情（1）在哪里插入projection（2）插入什么样的projection 比如说，我们在product groups 中要用table的rows来体现业务上的树状层级，我们就加入一个tree-plugin（与product groups业务本身无关），我们考虑的是：<br>在哪里pipe：修改structure projection pipe啥：加入parent node row<br>在哪里pipe：修改content projection pipe啥：添加icon和缩进描述层级关系</p>
<p><strong>How to compose async actions?</strong></p>
<p>我只想回答这么一句话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">f_async(…args)  ≡  f(condition, …args)</div></pre></td></tr></table></figure>
<p><strong>How to share components to public?</strong></p>
<ul>
<li>We share widgets and controls. we should not share business.</li>
<li>We can share universal helper functions in typical pure function way.</li>
<li>Pure functions are even easier to share: No side effects. Predicable</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/design-pattern/">design pattern</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/functional-programming/">functional programming</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-easy-ui" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/11/easy-ui/" class="article-date">
  	<time datetime="2017-12-11T02:26:12.000Z" itemprop="datePublished">2017-12-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/11/easy-ui/">Make UI development easy again</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作为前端开发者经常有被其他领域的工程师质疑：“你整天都在忙啥。不就是写个UI有那么难么？”当然我们可以找出很多例子来证明UI真的可以很难很高科技，比如说amazon那个魔术一般的wunderbar，但是我们加班真的在忙这些东西吗？我猜测绝大多数人跟我一样，头疼的task和bug都来自于无穷无尽的entity CRUD，表单，表格当中。所以我个人是很想赞同他们的质疑：“前端真的有那么难吗？”</p>
<h1 id="It-was-easy"><a href="#It-was-easy" class="headerlink" title="It was easy"></a>It was easy</h1><p>若干年之前，我们并没有javascript，也没有SPA，那时的web应用开发是非常简单清晰的。我们以经典的ROR（ruby on rails, 很多被广泛的使用的框架，如structs，spring, Yii, asp.net都深受其影响）为例：</p>
<p>建表(当然production中这么建表被fire了后果自负)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> (</div><div class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) NNOT <span class="literal">NULL</span> auto_increment,</div><div class="line">  <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</div><div class="line">  <span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>model</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></div><div class="line">  validates <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span></div><div class="line"></div><div class="line">  before_create <span class="keyword">do</span></div><div class="line">    <span class="keyword">self</span>.name = login.capitalize <span class="keyword">if</span> name.blank?</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>view</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> form_tag(<span class="string">"/login"</span>, <span class="symbol">method:</span> <span class="string">"post"</span>) <span class="keyword">do</span> </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> text_field_tag(<span class="symbol">:name</span>) </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> password_field_tag(<span class="symbol">:password</span>) </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line">  <span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> submit_tag(<span class="string">"Search"</span>) </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%</span></span><span class="ruby"> <span class="keyword">end</span> </span><span class="xml"><span class="tag">%&gt;</span></span></div></pre></td></tr></table></figure>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Hello: <span class="tag">&lt;<span class="name">%=</span></span><span class="ruby"> user.name </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>controller</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginsController</span> &lt; ApplicationController</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span></span></div><div class="line">    <span class="keyword">if</span> user = User.authenticate(params[<span class="symbol">:username</span>], params[<span class="symbol">:password</span>])</div><div class="line">      session[<span class="symbol">:current_user_id</span>] = user.id</div><div class="line">      redirect_to landing_url</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>这一切很简单，在经典的MVC+serverside rendering的架构中，controller和model都是在server side运行,controller来管理business logic：调用哪个model（User），进行什么操作（authenticate），结果是什么（成功则跳转），model用来管理数据：User的字段,query（本例中映射到数据库）等操作。而view，很诚实的根据model里的数据来渲染页面，提交表单。我们没有JavaScript，发不出change，onClick事件，没有办法在view里面进行正则验证，这些逻辑都由controller完成。</p>
<p><em>Recap</em>：</p>
<ol>
<li>UI = f(model),不会受其他data binding或者events的影响</li>
<li>view和controller之间划分了一条明显的界限</li>
</ol>
<p>好处：</p>
<ol>
<li>简单清晰，开发效率高，学习成本低</li>
<li>想象我们现在不用ejs作为模板引擎了，比如说用pug，controller基本不用啥改动。同样的，现在我们把db用mongodb替代mysql（事实上，我推荐个人小项目这么干），view基本不用改。</li>
</ol>
<p>你换angular试试？把validate写进filter里:P</p>
<p>举一个现实的例子，在campaign ui从ui server migrate到SPA的过程中，我们在UI server端最费心的是什么？删掉这个controller会不会有request 404。实际上，如果不是这么大规模的替换，根本用不了这么担心，比如上面提到的换模板引擎或者换db已经够大了吧。不用说简单（呵呵）的修改逻辑或者修改用户体验。</p>
<p>换knockout呢？看不懂的console error等着你</p>
<h2 id="why-we-move-away"><a href="#why-we-move-away" class="headerlink" title="why we move away"></a>why we move away</h2><p>To reduce UI friction!!</p>
<ol>
<li>每次重新渲染页面的perf无法接受</li>
<li>复杂交互的需求：animation等</li>
</ol>
<p>拿这写个gmail？微软的卧底才这么干。还是用angular吧=.=</p>
<h2 id="why-we-want-it-again"><a href="#why-we-want-it-again" class="headerlink" title="why we want it again?"></a>why we want it again?</h2><p>现在前端有大量MVC，MVVM框架，他们很优秀解决了无数的问题，但同时也引起开篇提出的质疑：现在前端是加班重灾区（jquery要接大锅，但与本文主题无关，略，并且相对于功劳，它不优雅之处并非主要）立下汗马功劳的events机制和data binding反过来在bite我们：</p>
<ol>
<li><p>hard bugs</p>
<p>在campaign creation的第一步和第四步，我们有两次让用户set buget的机会。如果我们让这两个budget control是一个instance:因为每一步的next和back button都会validate当前step所有的form,那么实际上，第一步和第四步的都执行了自己步骤以外的validation，这导致了很多bug；如果让他们是不同的instance，需要构造两次不说，其他受budget影响的component都需要监听或者分辨来自不同budget control的事件，或者判断传入的instance是不是当前想要的。数据和validation同步也是可能导致问题的。</p>
</li>
<li><p>DCR and rebranding</p>
<p>我们做了决定，deprecate monthly budget。然而 有很多已经存在的campaign apply了monthly budget， 所以settings页面需要保留monthly选项，creation页面需要删掉。</p>
<p>当我们已经在pilot 紧张的准备GA的时候，另外一个feature也要开始准备release了：shared budget。原来的budget control成为了一个child 和shared budget的control一起组成新的budget panel：所有的事件和接口，都需要转发。</p>
</li>
<li><p>painful debugging experience</p>
<p>我们有很多别的限制：不同的location，不同的language，budget的currency和limitation不一样，同时，bid是受到budget的限制的，traffic estimation是收到budget影响的。<br>别忘了，我们有两个budget control，而且未来有可能，面包屑上方的header里，会出现第三个。<br>别忘了，shared budget是和别的campaign关联的。budget除了value，还有type。是的，type还会变。你可以想象到我们在调试其中关于validation,关于filter，关于format，等等，bug的时候，不知道root cause在哪一脸懵逼的表情吗。</p>
</li>
<li><p>async</p>
<p>我们的render和destroy方法都是同步的。因为lazy loading的需求，我们需要在render的时候再加载一个第三方库，加载成功之后会创建一系列新的实体在其子节点上。destroy的时候，需要讲他们一一销毁：这时，一个很容易出bug的问题诞生了：你怎么知道destroy的时候render及其异步操作已经全部完成。稍不小心就会让程序进入无法预测的异常状态。</p>
<p>（1）改框架，render和destroy都支持promise。</p>
<ul>
<li>好主意，加油（微笑）争取明年release（doge）<br>（2）加全局flag</li>
<li>我们确实很多时候是怎么干的。</li>
<li>异步之后又fork出新的异步task怎么办</li>
<li>你怎么能保证线程安全？怎么能保证flag不被修改？如果之后的业务告诉你确实要修改flag怎么办？比如说，有两个同时进行的lazy loading。掀桌。</li>
</ul>
</li>
</ol>
<p>哦，对了，我们GA了之后，另外一个crew开始在我们的基础上做multiple language。原来language由enum，成为了数组或者enum。嗯。。。<br>我们加班就是在干这样的事情的。</p>
<h1 id="Make-it-easy-again"><a href="#Make-it-easy-again" class="headerlink" title="Make it easy again"></a>Make it easy again</h1><h2 id="We-want-both"><a href="#We-want-both" class="headerlink" title="We want both"></a>We want both</h2><p>回想一下我们为什么放弃了那些田园时代美好的东西：1. perf 2. ux requirements</p>
<p>不就是把server sider rendering换成client side rendering嘛，其他的逻辑组织一切都不变，完全平移到client side。或者说用javascript强行写一个ror或者asp.net搁浏览器里跑，可行吗？</p>
<p>当然可行，不过频繁的dom操作，依然让perf和体验不理想，可以归结为ui friction。好吧，我们写angular吧，我们写knockout吧，我们写backbone吧。</p>
<p>喷了一大圈，那些大神们果然还是比我们厉害啊。</p>
<h3 id="Not-a-blocker-now"><a href="#Not-a-blocker-now" class="headerlink" title="Not a blocker now"></a>Not a blocker now</h3><p>没想到现在我们迎来了一个大救星：virtual dom。放心的render，rerender吧，virtual dom刚我们干了reduce ui friction的活儿。咱们放心前进。</p>
<p>另一方面，对于很多局部的小控件，其实啊，重画是完全可以接受的，并不是ui friction，比方说，你就是一个小小的date picker之类的。</p>
<p>好了，现在我们可以回头找一下那一些被迫放弃的田园时代的美好吧。、</p>
<p><em>Recap</em>：</p>
<ol>
<li>UI = f(model),不会受其他data binding或者events的影响</li>
<li>view和controller之间划分了一条明显的界限</li>
</ol>
<h2 id="How？"><a href="#How？" class="headerlink" title="How？"></a>How？</h2><h3 id="状态递归"><a href="#状态递归" class="headerlink" title="状态递归"></a>状态递归</h3><p>controller是啥？描述状态转移的。compose出新的model 把这个新的model，交给新的view</p>
<p><strong>controller: old_model -&gt; new_model</strong></p>
<p>根据什么计算？废话，传进来的参数啊。别的东西我看不见看不见。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">new_model = r(old_model, params)</div></pre></td></tr></table></figure>
<p>在这里，我们并不像局限于某一种特定的pattern来讨论这些问题：viewmodel还是model，who cares？我们可以都叫他state</p>
<p>params也太局限了，我们也不想局限于某一种代码组织方式，controller function？controller class？这不重要，我们是来推销哲学的。我们就叫它action吧。</p>
<p>敲黑板，划重点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">state_next = r(state, action)</div></pre></td></tr></table></figure>
<p>r is a pure function!r is a pure function!r is a pure function!</p>
<h3 id="UI-f-state"><a href="#UI-f-state" class="headerlink" title="UI = f(state)"></a>UI = f(state)</h3><p>和以上同样的想法，把model扩展成state状态得到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UI = f(state)</div></pre></td></tr></table></figure>
<p>f is a pure function!f is a pure function!f is a pure function!</p>
<h3 id="pure-function"><a href="#pure-function" class="headerlink" title="pure function"></a>pure function</h3><ol>
<li>what</li>
</ol>
<ul>
<li>Given the same input, will always return the same output. 给定输入，则输出给定。</li>
<li>Produces no side effects. 没有副作用。</li>
</ul>
<p>The simplest reusable building blocks of code in a program</p>
<ul>
<li>Immune to entire classes of bugs that have to do with shared mutable state</li>
<li>Great candidates for parallel processing</li>
<li>Easy to move around</li>
</ul>
<p><em>FP(functional programing)的数学背景(如果时间允许且听众感兴趣的话)</em></p>
<p>(1) Category theory</p>
<p>(解释了为什么pure function对干扰免疫，没有副作用)<br>(思考问题的时候，一定注意把pure function理解成pipe，而不是execute，重点！pipe！)</p>
<ul>
<li>category: an algebraic structure that comprises “objects” that are linked by “arrows“</li>
<li>Consider the “category” as “container” which contains:<ul>
<li>values</li>
<li>transforming of values</li>
</ul>
</li>
</ul>
<p>(2) λ calc(lambda演算 然而JavaScript里的lambda 表达式不是真lambda表达式)</p>
<ul>
<li>λ-terms（解释了为什么“函数是一等公民”）<ul>
<li>variables: x</li>
<li>function creation/abstraction: λx.E</li>
<li>function application: E1 E2</li>
</ul>
</li>
<li>evaluation（解释了柯里化的数学原理，解释了FP对于异步和并行的优势，启发我们不要用传统的考虑“值”的思路（call by value）去理解而是call by name）<ul>
<li>Alpha equivalence( or conversion )</li>
<li>Beta reduction<ul>
<li>call by value</li>
<li>call by name</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li>why</li>
</ol>
<ul>
<li>we want UI to be predicable</li>
<li>we want UI transforming be predicable</li>
</ul>
<p>(不要拿随机数生成来抬杠，因为随机数的生成，是需要seed的)</p>
<ol>
<li>benefits</li>
</ol>
<ul>
<li>Easy to control the order</li>
<li>Easy to pass in additional data</li>
<li>Easy to make reusable reduce functions</li>
</ul>
<ol>
<li>How</li>
</ol>
<ul>
<li>currying</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">status</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">      <span class="comment">// fancy logging code here</span></div><div class="line">    &#125;;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> info = log(<span class="string">'info'</span>); <span class="comment">// create a new function "info" by fixing first argument</span></div><div class="line">info(<span class="string">'db-context'</span>)(<span class="string">'message'</span>);</div><div class="line"></div><div class="line">log(<span class="string">'other level'</span>)(<span class="string">'some context'</span>)(<span class="string">'a message'</span>); <span class="comment">// use the original function directly with all arguments</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> dbInfo = info(<span class="string">'db'</span>); <span class="comment">// create a new function again</span></div><div class="line">dbInfo(<span class="string">'something happened'</span>);</div></pre></td></tr></table></figure>
<ul>
<li>partial</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">status, context, message</span>) </span>&#123;</div><div class="line">  <span class="comment">// fancy logging code here</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params">context, message</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> log(<span class="string">'info'</span>, context, message);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">dbInfo</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> info(<span class="string">'db'</span>, message);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>immutable</p>
<ul>
<li>Some side effects avoided.</li>
<li>Pure functions easier to write.</li>
<li>Fast change detection.</li>
<li>Immutable data can be safely cached.</li>
<li>Easier to implement undo.</li>
<li>Concurrency.</li>
</ul>
</li>
</ul>
<h3 id="Deep-in-r-centralized-state-management"><a href="#Deep-in-r-centralized-state-management" class="headerlink" title="Deep in r - centralized state management"></a>Deep in r - centralized state management</h3><ol>
<li><p>state is read-only</p>
<ul>
<li>It is immutability</li>
<li>all changes are centralized and happen one by one in a strict order</li>
<li>Easy to be logged, serialized, stored, and later replayed for debugging or testing purposes.</li>
</ul>
</li>
<li><p>Changes are made with pure functions</p>
</li>
</ol>
<h3 id="Deep-in-f-UI-as-function-of-state"><a href="#Deep-in-f-UI-as-function-of-state" class="headerlink" title="Deep in f - UI as function of state"></a>Deep in f - UI as function of state</h3><ol>
<li>One-way data binding</li>
<li><p>single source of truth</p>
<p> 我们之前遇到的各种前端框架显然不满足f(Status) = UI，通常来说，应该是<br>   f(Status, 用户交互，推送信息，其他UI联动变化，……) = UI<br> 那么React必然要做的事情就是实现一个:g(上面其他因素) = status，这就是需要单向数据流的原因。<br> 我个人的体会，因为可能已经习惯了诸如knockout、angularjs等成熟的框架提供的各种完善的two-way data-binding的机制，第一眼很难接受React的one-way data flow，而且写一些很小的component的时候（比如hello world之类的），会发现很简单的事情反而需要我们花一些额外的精力。<br> 比如一个最简单的input框，如果用ko，只需要把他和vm上一个observable绑定就好了，在ng中也是很简单的ng-model=xxx，但是突然React告诉你，不行，你要绕一圈，你的输入只能作用于status的update，绕一圈才能回到UI的变化，当然不习惯。<br> Facebook的工程师们肯定不是吃饱了撑的才这样设计。我们可以想象一些稍微复杂的逻辑——比如，如果这个input框需要把用户的输入全部转成大写字母，或者拒绝掉一些非法字符。当然，现在的框架已经足够优秀，我们可以pass in各种custom filter。问题就在于当这些需求一个一个堆砌起来，逻辑就会逐渐变得混乱，filter，suscription，events等等聚集在一起，代码的可读性会严重降低且难以维护。当UI中的元素越来越多，业务越来越复杂，这些不便利之处会指数级爆炸。<br>而单向的数据流就不存在这些问题了，flux中有一个很好的Dispature和Store的概念，就像现代物流的集散分拣中心一样的（此处谢绝抬杠），一件快递的时候看起来不必要，但是成千上万的数据涌来，他依然能把所有的东西处理得井井有条，所有的东西就像阅兵式上的方阵，清晰有条理。我们会被从filter，suscription，events中被拯救出来，只有两样简单的事情：status，UI。</p>
</li>
</ol>
<h1 id="Tail"><a href="#Tail" class="headerlink" title="Tail"></a>Tail</h1><p>我们不是来sell某一种框架或者技术的。更多的是想抛砖引玉，启发大家如何借助一些最新的力量，在保留我们已有的财富的同时，找到一次前端的“文艺复新”。当然和文艺复新一样，这里也是旧瓶装新酒。这里的flux pattern和传统的MVC相比，也有了不少变化，下面会说明。</p>
<p>可能喜欢在技术上赶时髦的同学已经想把那几个框架或者技术的名字呼之欲出了。但是这不是这里想要deliver的东西。这里只是讲一种pattern，我们更希望它随时随地，哪怕我们在处理没有用那些新的框架的时候，也能启发我们，让我们的工作更加简单。用到的时候，更能体会作者的良苦用心，为什么这样做，而不是API的搬运工。事实上，这种思考问题的方法，这种设计的思路，真的不需要通过哪个框架或者技术才能实现。Jquery？Why not？</p>
<h2 id="case-study-projection-grid"><a href="#case-study-projection-grid" class="headerlink" title="case study: projection-grid"></a>case study: projection-grid</h2><ol>
<li>predicable: 只要projection确定了，内容就确定。</li>
<li>renderer并不关注projection如何被pipe，如何被compose，只需要关心render model长什么样子就能画出grid</li>
<li>React，vue，backbone版本只是renderer不一样，如何计算render model完全不用重复。所以：不同情形下可以重用同一份plugin！</li>
<li>Debug：只需要关注render model，就能查找是compose model发生的错误还是在render时发生。</li>
<li>Test：对于core，只需要关注IO，对于renderer，只需要关注给定render model之后的snapshot。</li>
<li>Extensibility: 通过pipe更多的plugin。plugin是pure function或plain object(这是语法糖，实际上我们都处理成reducer，即，根据现有配置和参数（state and action）返回新的配置（new state）)</li>
</ol>
<h2 id="Flux-pattern"><a href="#Flux-pattern" class="headerlink" title="Flux pattern"></a>Flux pattern</h2><ul>
<li>View: representation layer. Controller views.</li>
<li>Action: raise actions from representational layer.</li>
<li>Dispatcher: receive actions and invoke callbacks.</li>
<li>Store: respond to dispatched actions.</li>
</ul>
<h3 id="Controller-Views-Pattern"><a href="#Controller-Views-Pattern" class="headerlink" title="Controller Views Pattern"></a>Controller Views Pattern</h3><ul>
<li>Separate controllers(container components) and views(representational components)</li>
<li>Benefits<ul>
<li>More portable.</li>
<li>Less cognitive overhead.</li>
<li>Easier testing.</li>
</ul>
</li>
</ul>
<h2 id="Frequende-asked-questions"><a href="#Frequende-asked-questions" class="headerlink" title="Frequende asked questions:"></a>Frequende asked questions:</h2><p>Q: how to share components to public?<br>A:</p>
<ul>
<li>We share widgets and controls. we should not share business.</li>
<li>We can share universal helper functions in typical pure function way.</li>
<li>Pure functions are even easier to share: No side effects. Predicable</li>
<li>Higher ordered components.</li>
</ul>
<p>Q: how to compose async actions?<br>A:<br>这不就是λx condition的问题吗？柯里化。看似复杂的问题背后一定有简单的数学原理。</p>
<p>Q: In big team co-work, how to break projects down?<br>A</p>
<ul>
<li>Trandional: application -&gt; modules -&gt; controllers + views + models(viewmodels) | MVVM or other patterns</li>
<li>Applying middleware:(如果我们用函数式思考，一切非常自然)<ul>
<li>application = middleware1(middleware2(middleware3(…midlewareN(config))))</li>
<li>or application = middleware1(config1)(middleware2(config2))(…)(middlewareN(configN))</li>
</ul>
</li>
</ul>
<p>(如果我们用函数式思考，一切非常自然)</p>
<p>回答这个问题，我建议大家先来这样思考我们的项目，想象成一个表格，或者数据库表，也就是一个二维的矩阵，一个维度是不同的业务实体，在这里就是不同种类的campaign；另一个维度与它垂直，就像是auth, i18n, theming，routing等等，你每一行代码的作用，就都可以用一个向量来表示：我这一行，是处理DSA的i18n。那么两种思考问题的方式其实就是一个地方不一样：把哪个维度看成行，把哪个维度看成列。</p>
<p>传统的方法是根据业务来思考的。而这里推荐的另一个看问题的角度，是通过可扩展性，可维护性，（说人话：呼应标题，让前端开发变简单）的方面来思考。这和数据库很类似：列扩展很简单，一条SQL语句即可，行扩展相对麻烦。所以我们用middleware来描述我们的列:<br>一方面，借助柯里化，当我们需要扩展列（增加新的middleware）时，代价不那么大<br>另一方面，当我们增加业务实体时（这是我们的主要工作，除了架构师）进行简单的行扩展</p>
<p>比方说 auth, i18n, theming，routing等等作为middleware避免了大量重复代码。我们平时在处理这些逻辑的时候，就算不是copy paste，互相之间的差别也不大，基本上是配置上的差别。</p>
<p>那么我们会问这样一个问题，如果我要在我们的项目中加入一个新的entity，举个例子，我们已经有了几种campaign，search campaign，shopping campaign等等，现在我们又要加入DSA campaign.</p>
<p>传统的做法是加入一个DSACampaignController,里面包含CRUD的actions，然后创建相应的View，templates，和campaignMT，adInsight MT integrate之后release，当然这些和之前其他campaign的code会有很多重复但是我们似乎也能接受（其实是习惯了）</p>
<p>按照上面的做法，是不是说我要在auth里添加一点DSA的配置，i18n里添加几个DSA的规则，说起来不用写完整的重复的controller啊之类的，但是这种散弹式的修改真的不是团队协作的毒药吗？怎么不像上面说的“行扩展”那样简单啊？<br>回答：</p>
<ol>
<li>设计出声明式编程的接口很难吗？设计出集中配置项的语法糖很难吗？最最简单的，有一个middleware来派送config给不同的middleware总能做到吧。</li>
<li>flux pattern中一个重要的角色是dispatcher，具体的应用中不同框架有不同的设计，但是功能都是：把不同的action分发到不同的store或者store里的不同字段。比方说一个简单的设计，不就是hash map吗？添加新的DSA campaign type，可以设计成为为这个新的entity action添加新的reducer（就是前面讲到的r的组件，或新的一组reducer）</li>
</ol>
<p>当然由此还会有一个问题：如果维度不够用怎么办？拿业务上说就是：我们的business entity不一定是扁平的结构，就比如说，我们有不同type的campaign，这是一层，不同type的adgroup，ads， keywords等等，然后campaign,ads,keywords这些又是拿到一层考虑：</p>
<p>flatten：可能很多时候我们并不需要关系这些业务上的树形关系，共性和特性就是柯里化中的小技巧了。<br>数学上的分形，或者结合micro service的理念，通过子APP的方式来完成。</p>
<p>可能还是有点抽象，还是举projection grid中的例子吧：</p>
<p>不同场景下，datasource的不同，toolbar构造的不同，只体现在配置不同上。<br>功能上的扩展，对于开发者来说，考虑两件事情（1）在哪里插入projection（2）插入什么样的projection 比如说，我们在product groups 中要用table的rows来体现业务上的树状层级，我们就加入一个tree-plugin（与product groups业务本身无关），我们考虑的是：<br>在哪里pipe：修改structure projection pipe啥：加入parent node row<br>在哪里pipe：修改content projection pipe啥：添加icon和缩进描述层级关系</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-deps-collection" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/18/deps-collection/" class="article-date">
  	<time datetime="2017-10-18T02:22:55.000Z" itemprop="datePublished">2017-10-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/18/deps-collection/">Data binding: hijack and dependencies collection</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>见过的前端js框架，data-binding的实现方案大致有三种：</p>
<ul>
<li>直接把数据的暴露成function,如knockout</li>
<li>dirty check, 如angular</li>
<li>劫持getter,setter + 依赖收集,如vue</li>
</ul>
<p>写下第三种：</p>
<p><a href="https://github.com/vuejs/vue/blob/dev/src/core/observer/index.js" target="_blank" rel="external">Vue 源码</a></p>
<p>我们的demo code是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">form</div><div class="line">  input(type=&quot;text&quot;, v-bind=&quot;count&quot;)</div><div class="line">  button(type=&quot;button&quot;, v-click=&quot;increment&quot;) increment</div><div class="line">div(v-bind=&quot;count&quot;)</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; Observable, Watcher &#125; <span class="keyword">from</span> <span class="string">'@bingads-webui/simple-observable'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> Observable(&#123;</div><div class="line">  firstName: <span class="string">'Michael'</span>,</div><div class="line">  lastName: <span class="string">'Jordan'</span>,</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">new</span> Watcher(person, <span class="string">'fullName'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;person.firstName&#125;</span> <span class="subst">$&#123;person.lastName&#125;</span>`</span>;</div><div class="line">&#125;, (val) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`The full name is <span class="subst">$&#123;val&#125;</span>`</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(person.fullName);</div><div class="line"></div><div class="line">person.lastName = <span class="string">'Jackson'</span>;</div><div class="line"></div><div class="line"><span class="built_in">window</span>.person = person;</div></pre></td></tr></table></figure>
<p>带dom操作的:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; App &#125; <span class="keyword">from</span> <span class="string">'@bingads-webui/simple-observable'</span>;</div><div class="line"><span class="keyword">import</span> template <span class="keyword">from</span> <span class="string">'./index.pug'</span>;</div><div class="line"></div><div class="line"><span class="keyword">new</span> App(&#123;</div><div class="line">  el: <span class="built_in">document</span>.body,</div><div class="line">  template,</div><div class="line">  data: &#123;</div><div class="line">    count: <span class="number">3</span>,</div><div class="line">  &#125;,</div><div class="line">  method: &#123;</div><div class="line">    increment: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">this</span>.data.count++;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h1><h2 id="在属性被读写的时候主动通知："><a href="#在属性被读写的时候主动通知：" class="headerlink" title="在属性被读写的时候主动通知："></a>在属性被读写的时候主动通知：</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> person = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="keyword">let</span> firstName = <span class="string">'Michael'</span>;</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(person, <span class="string">'firstName'</span>, &#123;</div><div class="line">  get() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Reading person.firstName'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'Michael'</span>;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  set(val) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Setting person.firstName <span class="subst">$&#123;val&#125;</span>`</span>);</div><div class="line"></div><div class="line">    firstName = val;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们可以定义最基本的observable类和defineReactive方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</div><div class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      <span class="comment">// todo</span></div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    set(newVal) &#123;</div><div class="line">      <span class="comment">// todo</span></div><div class="line"></div><div class="line">      val = newVal;</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">obervable</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj);</div><div class="line"></div><div class="line">  keys.forEach((key) =&gt; &#123;</div><div class="line">    defineReactive(obj, key, obj[key]);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Refactor一下，写成class</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observable</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.walk(obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  walk(obj) &#123;</div><div class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj);</div><div class="line"></div><div class="line">    keys.forEach((key) =&gt; &#123;</div><div class="line">      <span class="keyword">this</span>.defineReactive(obj, key, obj[key]);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineReactive(obj, key, val) &#123;</div><div class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        <span class="comment">// todo</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set(newVal) &#123;</div><div class="line">        <span class="comment">// todo</span></div><div class="line"></div><div class="line">        val = newVal;</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h1><p>现在来实现demo中的这个部分：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Watcher(person, <span class="string">'fullName'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;person.firstName&#125;</span> <span class="subst">$&#123;person.lastName&#125;</span>`</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>(有没有觉得和dirty check里面的$$watchers很像。。。后面还有更像的)</p>
<ul>
<li>watcher属性无法被赋值</li>
<li>watcher的值由第三个参数决定</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">watcher</span>(<span class="params">obj, key, getVal</span>) </span>&#123;</div><div class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      <span class="keyword">const</span> val = getVal();</div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line">    set() &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot set values of wathers.'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>改写成watcher类并加入listener</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj, key, cb， onComputedUpdate) &#123;</div><div class="line">    <span class="keyword">this</span>.obj = obj;</div><div class="line">    <span class="keyword">this</span>.key = key;</div><div class="line">    <span class="keyword">this</span>.cb = cb;</div><div class="line">    <span class="keyword">this</span>.onComputedUpdate = onComputedUpdate;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.defineComputed();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineComputed() &#123;</div><div class="line">    <span class="keyword">const</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> onDepUpdated = () =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.obj, <span class="keyword">this</span>.key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        <span class="keyword">const</span> val = self.cb();</div><div class="line">        <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set() &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot set values of wathers.'</span>);</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样observable和watcher就可以一起工作了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> Observable(&#123; firstName: <span class="string">'Michael'</span>, lastName: <span class="string">'Jordan'</span> &#125;);</div><div class="line"></div><div class="line"><span class="keyword">new</span> Watcher(person, <span class="string">'fullName'</span>, () =&gt; <span class="string">`<span class="subst">$&#123;person.firstName&#125;</span> <span class="subst">$&#123;person.lastName&#125;</span>`</span>, (val) =&gt; &#123; <span class="built_in">console</span>.log(<span class="string">`new value <span class="subst">$&#123;val&#125;</span>`</span>) &#125;);</div></pre></td></tr></table></figure>
<h1 id="Dependencies-collection"><a href="#Dependencies-collection" class="headerlink" title="Dependencies collection"></a>Dependencies collection</h1><p>这样有一个问题：我们是主动去取fullName的值的时候，它才会被计算。而我们期望的行为，是firstName或者lastName被修改的时候，主动通知fullName，并更新,触发onComputedUpdate。<br>可以设计这样一个dependency collector, 来收集所有的dependencies. 具体一点就是,让一个observable知道有哪些watcher依赖它,并且在自己被赋值的时候通知watcher.</p>
<p>注意到watcher的getter被call到的时候,它依赖哪些observable,就会call到这些observable,可以用这个时机来告诉observable,这个watcher依赖你了.然后在call到setter时,就可以把dependencies拿出来通知:</p>
<p>简单版本,拿一个全局变量存dependencies做依赖收集器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Dep = &#123;</div><div class="line">  target: <span class="literal">null</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>在watcher中:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">defineComputed() &#123;</div><div class="line">  <span class="keyword">const</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">  <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.obj, <span class="keyword">this</span>.key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      Dep.target = () =&gt; &#123;</div><div class="line">        <span class="keyword">const</span> val = self.cb();</div><div class="line">        <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    set() &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot set values of wathers.'</span>);</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在observable中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">defineReactive(obj, key, val) &#123;</div><div class="line">  <span class="keyword">const</span> deps = [];</div><div class="line"></div><div class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">    get() &#123;</div><div class="line">      deps.push(Dep.target);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> val;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    set(newVal) &#123;</div><div class="line">      val = newVal;</div><div class="line">      deps.forEach(dep =&gt; dep());</div><div class="line">    &#125;,</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'underscore'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>() &#123;</div><div class="line">    <span class="keyword">this</span>.deps = [];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  depend() &#123;</div><div class="line">    <span class="keyword">if</span> (Dep.target &amp;&amp; <span class="keyword">this</span>.deps.indexOf(Dep.target) === <span class="number">-1</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.deps.push(Dep.target);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  notify() &#123;</div><div class="line">    <span class="keyword">this</span>.deps.forEach((dep) =&gt; &#123;</div><div class="line">      dep();</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Dep.target = <span class="literal">null</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observable</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.walk(obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  walk(obj) &#123;</div><div class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj);</div><div class="line"></div><div class="line">    keys.forEach((key) =&gt; &#123;</div><div class="line">      <span class="keyword">this</span>.defineReactive(obj, key, obj[key]);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineReactive(obj, key, val) &#123;</div><div class="line">    <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep();</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        dep.depend();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set(newVal) &#123;</div><div class="line">        val = newVal;</div><div class="line">        dep.notify();</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(obj, key, cb, onComputedUpdate) &#123;</div><div class="line">    <span class="keyword">this</span>.obj = obj;</div><div class="line">    <span class="keyword">this</span>.key = key;</div><div class="line">    <span class="keyword">this</span>.cb = cb;</div><div class="line">    <span class="keyword">this</span>.onComputedUpdate = onComputedUpdate;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.defineComputed();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  defineComputed() &#123;</div><div class="line">    <span class="keyword">const</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> onDepUpdated = () =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.onComputedUpdate(val);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.obj, <span class="keyword">this</span>.key, &#123;</div><div class="line">      get() &#123;</div><div class="line">        Dep.target = onDepUpdated;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> val = self.cb();</div><div class="line"></div><div class="line">        Dep.target = <span class="literal">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> val;</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      set() &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot assign value computed!'</span>);</div><div class="line">      &#125;,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(&#123; el, template, data, method &#125;) &#123;</div><div class="line">    <span class="keyword">this</span>.el = el;</div><div class="line">    <span class="keyword">this</span>.template = template;</div><div class="line">    <span class="keyword">this</span>.data = <span class="keyword">new</span> Observable(data);</div><div class="line">    <span class="keyword">this</span>.method = method;</div><div class="line">    <span class="keyword">this</span>.render();</div><div class="line">    <span class="keyword">this</span>.applyBindings();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  applyBindings() &#123;</div><div class="line">    <span class="keyword">const</span> bindList = <span class="keyword">this</span>.el.querySelectorAll(<span class="string">'[v-bind]'</span>);</div><div class="line"></div><div class="line">    _.each(bindList, (bind) =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> bindKey = bind.getAttribute(<span class="string">'v-bind'</span>);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (bind.tagName === <span class="string">'INPUT'</span>) &#123;</div><div class="line">        <span class="comment">// bind.value = this.data[bindKey];</span></div><div class="line"></div><div class="line">        <span class="keyword">new</span> Watcher(<span class="keyword">this</span>.data, <span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>Value`</span>, () =&gt; &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.data[bindKey];</div><div class="line">        &#125;, (newVal) =&gt; &#123;</div><div class="line">          bind.value = newVal;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        bind.value = <span class="keyword">this</span>.data[<span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>Value`</span>];</div><div class="line"></div><div class="line">        bind.addEventListener(<span class="string">'input'</span>, (e) =&gt; &#123;</div><div class="line">          <span class="keyword">this</span>.data[bindKey] = e.target.value;</div><div class="line">        &#125;);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">new</span> Watcher(<span class="keyword">this</span>.data, <span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>InnerHtml`</span>, () =&gt; &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.data[bindKey];</div><div class="line">        &#125;, (newVal) =&gt; &#123;</div><div class="line">          bind.innerHTML = newVal;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        bind.innerHTML = <span class="keyword">this</span>.data[<span class="string">`$<span class="subst">$&#123;bindKey&#125;</span>InnerHtml`</span>];</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> clickList = <span class="keyword">this</span>.el.querySelectorAll(<span class="string">'[v-click]'</span>);</div><div class="line"></div><div class="line">    _.each(clickList, (click) =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> clickKey = click.getAttribute(<span class="string">'v-click'</span>);</div><div class="line">      <span class="keyword">const</span> clickFunc = <span class="keyword">this</span>.method[clickKey];</div><div class="line"></div><div class="line">      click.onclick = clickFunc.bind(<span class="keyword">this</span>);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">this</span>.el.innerHTML = <span class="keyword">this</span>.template();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-binding/">data binding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/framework/">framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-dirty-check" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/11/dirty-check/" class="article-date">
  	<time datetime="2017-10-11T07:31:04.000Z" itemprop="datePublished">2017-10-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/11/dirty-check/">data-binding: dirty check</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>见过的前端js框架，data-binding的实现方案大致有三种：</p>
<ul>
<li>直接把数据的暴露成function,如knockout</li>
<li>dirty check, 如angular</li>
<li>劫持getter,setter + 依赖收集,如vue</li>
</ul>
<p>自己实现了一个非常简化的dirty-check</p>
<h1 id="watchers"><a href="#watchers" class="headerlink" title="$$watchers"></a>$$watchers</h1><p>scope是angular中最重要的一个概念，这里不再重复。用dirty check来实现data binding,scope中的$$watchers起到了核心的作用。$$watchers是一个数组，用于存放scope下所有的数据。每个数据有以下几个字段：</p>
<ul>
<li>name: 变量名，就是$scope.someName中的someName</li>
<li>last: 变量上一次的值，这是一个值。</li>
<li>newVal: 获取新值的函数，这是个函数。</li>
<li>listener: 监听的回掉函数。</li>
</ul>
<h1 id="watch"><a href="#watch" class="headerlink" title="$watch"></a>$watch</h1><p>将一个新的成员加入$$watchers</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$watch(name, exp, listener = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;) &#123;</div><div class="line">  <span class="keyword">this</span>.$$watchers.push(&#123;</div><div class="line">    name,</div><div class="line">    last: <span class="string">''</span>,</div><div class="line">    newVal: exp,</div><div class="line">    listener,</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有了$watch方法，我们就可以把scope中的所有值都加入$$watchers:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> $scope) &#123;</div><div class="line">  <span class="keyword">if</span> (key != <span class="string">'$$watchers'</span> &amp;&amp; !_.isFunction($scope[key])) &#123;</div><div class="line">    $scope.$watch(key, () =&gt; $scope[key]);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="digest"><a href="#digest" class="headerlink" title="$digest"></a>$digest</h1><p>$digest的作用，就是遍历$$watchers里所有的值，比较新值和旧值，调用listener，并把新值赋值给last,直到所有的新值旧值都相等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$digest() &#123;</div><div class="line">  <span class="keyword">let</span> dirty = <span class="literal">true</span>;</div><div class="line"></div><div class="line">  <span class="keyword">while</span> (dirty) &#123;</div><div class="line">    dirty = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    _.each(<span class="keyword">this</span>.$$watchers, (watcher) =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> newVal = watcher.newVal();</div><div class="line">      <span class="keyword">const</span> oldVal = watcher.last;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (newVal !== oldVal &amp;&amp; !_.isNaN(newVal) &amp;&amp; !_.isNaN(oldVal)) &#123;</div><div class="line">        dirty = <span class="literal">true</span>;</div><div class="line">        watcher.listener(oldVal, newVal);</div><div class="line">        watcher.last = newVal;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再加入更新dom元素的逻辑，就变成了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">$digest() &#123;</div><div class="line">    <span class="keyword">const</span> bindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-bind]'</span>);</div><div class="line">    <span class="keyword">let</span> dirty = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (dirty) &#123;</div><div class="line">      dirty = <span class="literal">false</span>;</div><div class="line"></div><div class="line">      _.each(<span class="keyword">this</span>.$$watchers, (watcher) =&gt; &#123;</div><div class="line">        <span class="keyword">const</span> newVal = watcher.newVal();</div><div class="line">        <span class="keyword">const</span> oldVal = watcher.last;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (newVal !== oldVal &amp;&amp; !_.isNaN(newVal) &amp;&amp; !_.isNaN(oldVal)) &#123;</div><div class="line">          dirty = <span class="literal">true</span>;</div><div class="line">          watcher.listener(oldVal, newVal);</div><div class="line">          watcher.last = newVal;</div><div class="line"></div><div class="line">          _.each(bindList, (bind) =&gt; &#123;</div><div class="line">            <span class="keyword">const</span> modelName = bind.getAttribute(<span class="string">'ng-bind'</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (modelName === watcher.name) &#123;</div><div class="line">              <span class="keyword">if</span> (bind.tagName === <span class="string">'INPUT'</span>) &#123;</div><div class="line">                bind.value = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                bind.innerHTML = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h1 id="绑定到dom"><a href="#绑定到dom" class="headerlink" title="绑定到dom"></a>绑定到dom</h1><p>剩余的工作就是把一些dom事件绑定一下，这里简单的绑定一下click button和inputbox的change</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> clickBindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-click]'</span>);</div><div class="line"></div><div class="line">_.each(clickBindList, (clickBind) =&gt; &#123;</div><div class="line">  clickBind.onclick = () =&gt; &#123;</div><div class="line">    $scope[clickBind.getAttribute(<span class="string">'ng-click'</span>)]();</div><div class="line">    $scope.$digest();</div><div class="line">  &#125;;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> inputList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'input[ng-bind]'</span>);</div><div class="line"></div><div class="line">_.each(inputList, (input) =&gt; &#123;</div><div class="line">  input.addEventListener(<span class="string">'input'</span>, () =&gt; &#123;</div><div class="line">    $scope[input.getAttribute(<span class="string">'ng-bind'</span>)] = input.value;</div><div class="line">    $scope.$digest();</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'underscore'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scope</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>() &#123;</div><div class="line">    <span class="keyword">this</span>.$$watchers = [];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  $watch(name, exp, listener = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;) &#123;</div><div class="line">    <span class="keyword">this</span>.$$watchers.push(&#123;</div><div class="line">      name,</div><div class="line">      last: <span class="string">''</span>,</div><div class="line">      newVal: exp,</div><div class="line">      listener,</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  $digest() &#123;</div><div class="line">    <span class="keyword">const</span> bindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-bind]'</span>);</div><div class="line">    <span class="keyword">let</span> dirty = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (dirty) &#123;</div><div class="line">      dirty = <span class="literal">false</span>;</div><div class="line"></div><div class="line">      _.each(<span class="keyword">this</span>.$$watchers, (watcher) =&gt; &#123;</div><div class="line">        <span class="keyword">const</span> newVal = watcher.newVal();</div><div class="line">        <span class="keyword">const</span> oldVal = watcher.last;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (newVal !== oldVal &amp;&amp; !_.isNaN(newVal) &amp;&amp; !_.isNaN(oldVal)) &#123;</div><div class="line">          dirty = <span class="literal">true</span>;</div><div class="line">          watcher.listener(oldVal, newVal);</div><div class="line">          watcher.last = newVal;</div><div class="line"></div><div class="line">          _.each(bindList, (bind) =&gt; &#123;</div><div class="line">            <span class="keyword">const</span> modelName = bind.getAttribute(<span class="string">'ng-bind'</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (modelName === watcher.name) &#123;</div><div class="line">              <span class="keyword">if</span> (bind.tagName === <span class="string">'INPUT'</span>) &#123;</div><div class="line">                bind.value = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                bind.innerHTML = <span class="keyword">this</span>[modelName];</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ngController</span>(<span class="params">controller</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> $scope = <span class="keyword">new</span> Scope();</div><div class="line"></div><div class="line">  controller($scope);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> clickBindList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'[ng-click]'</span>);</div><div class="line"></div><div class="line">  _.each(clickBindList, (clickBind) =&gt; &#123;</div><div class="line">    clickBind.onclick = () =&gt; &#123;</div><div class="line">      $scope[clickBind.getAttribute(<span class="string">'ng-click'</span>)]();</div><div class="line">      $scope.$digest();</div><div class="line">    &#125;;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> inputList = <span class="built_in">document</span>.querySelectorAll(<span class="string">'input[ng-bind]'</span>);</div><div class="line"></div><div class="line">  _.each(inputList, (input) =&gt; &#123;</div><div class="line">    input.addEventListener(<span class="string">'input'</span>, () =&gt; &#123;</div><div class="line">      $scope[input.getAttribute(<span class="string">'ng-bind'</span>)] = input.value;</div><div class="line">      $scope.$digest();</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> $scope) &#123;</div><div class="line">    <span class="keyword">if</span> (key != <span class="string">'$$watchers'</span> &amp;&amp; !_.isFunction($scope[key])) &#123;</div><div class="line">      $scope.$watch(key, () =&gt; $scope[key]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  $scope.$digest();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ngController(($scope) =&gt; &#123;</div><div class="line">  $scope.count = <span class="number">0</span>;</div><div class="line">  $scope.increment = () =&gt; &#123;</div><div class="line">    $scope.count++;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/data-binding/">data binding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/framework/">framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-defineObject-and-observable-watch" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/27/defineObject-and-observable-watch/" class="article-date">
  	<time datetime="2017-09-27T12:26:26.000Z" itemprop="datePublished">2017-09-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/27/defineObject-and-observable-watch/">Object.defineProperty</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty"></a>Object.defineProperty</h1><p>在js中我们用可以用这样几种方法定义属性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo.bar = <span class="string">'abc'</span>;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo[<span class="string">'bar'</span>] = <span class="string">'abc'</span>;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.defineProperty(foo, <span class="string">'bar'</span>, &#123;</div><div class="line">  value: <span class="string">'abc'</span>,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>defineProperty(<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="external">MDN链接</a>)这种方法，最麻烦，最强大.</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.defineProperty(obj, prop, descriptor)</div></pre></td></tr></table></figure>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><ul>
<li>obj: 需要被操作的目标对象</li>
<li>prop: 目标对象需要定义或修改的属性的名称</li>
<li>descriptor: 将被定义或修改的属性的描述符。</li>
</ul>
<h2 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h2><p>被传递给函数的对象</p>
<h2 id="descriptor"><a href="#descriptor" class="headerlink" title="descriptor"></a>descriptor</h2><p>之前列出来的比较简单的两种写法，是通过赋值来创建并显示在属性枚举中（<code>for...in</code>或<code>Object.keys</code>），可以被修改，也可以被删除。使用definePropery,可以控制这些：</p>
<ul>
<li>configurable: 这个值为true时，descriptor才可以被修改，同时这个property也能从obj上被删除。默认为false。</li>
<li>enumerable: 这个值为true时，才可以出现在<code>for...in</code>或者<code>Object.keys</code>中</li>
<li>value: property的值。默认undefined。</li>
<li>writable: 这个值为true时，propery才能被赋值运算符改变。默认false。</li>
<li>get/set: 就跟其他的getter/setter差不多，包括es6的getter/setter</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-on-vs-listenTo" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/10/on-vs-listenTo/" class="article-date">
  	<time datetime="2017-07-10T09:06:50.000Z" itemprop="datePublished">2017-07-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/10/on-vs-listenTo/">Backbone model- on vs listenTo</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>发现好久没有写blog了 要捡回来这个好习惯：）</p>
<p>今天遇到了一个bug，给一个全局的（不要吐槽,legacy code留下来的全局的东西没那么好消灭干净）添加了一个事件的callback，大致代码是这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">aGlobalModel.on(<span class="string">'a-event'</span>, () =&gt; &#123;</div><div class="line">  someView.doSomething();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>原因是，someView被remove的时候，忘了call gGlabal.off. Ok, 加上off逻辑当然不难，但是：</p>
<ol>
<li>直接call off会清理掉所有的handler。这坑爹货是全局的。。。。</li>
<li>可以指定off哪一个callback，所以这个callback会被传来传去。。比方说有很多处会remove的情况。on 并不是在someView里定义的。</li>
</ol>
<p>事实上，listenTo是一个更好的选择。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">someView.listenTo(aGlobalModel, <span class="string">'a-event'</span>, () =&gt; &#123;</div><div class="line">  <span class="comment">// ...code</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>当someView的remove被call到的时候 会自动的执行stopListening.</p>
<h3 id="看一下Backbone源码"><a href="#看一下Backbone源码" class="headerlink" title="看一下Backbone源码"></a>看一下Backbone源码</h3><ul>
<li>on</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Bind an event to a `callback` function. Passing `"all"` will bind</span></div><div class="line"><span class="comment">// the callback to all events fired.</span></div><div class="line">Events.on = <span class="function"><span class="keyword">function</span>(<span class="params">name, callback, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>._events = eventsApi(onApi, <span class="keyword">this</span>._events || &#123;&#125;, name, callback, &#123;</div><div class="line">    context: context,</div><div class="line">    ctx: <span class="keyword">this</span>,</div><div class="line">    listening: _listening</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (_listening) &#123;</div><div class="line">    <span class="keyword">var</span> listeners = <span class="keyword">this</span>._listeners || (<span class="keyword">this</span>._listeners = &#123;&#125;);</div><div class="line">    listeners[_listening.id] = _listening;</div><div class="line">    <span class="comment">// Allow the listening to use a counter, instead of tracking</span></div><div class="line">    <span class="comment">// callbacks for library interop</span></div><div class="line">    _listening.interop = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>listenTo</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Inversion-of-control versions of `on`. Tell *this* object to listen to</span></div><div class="line"><span class="comment">// an event in another object... keeping track of what it's listening to</span></div><div class="line"><span class="comment">// for easier unbinding later.</span></div><div class="line">Events.listenTo = <span class="function"><span class="keyword">function</span>(<span class="params">obj, name, callback</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!obj) <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  <span class="keyword">var</span> id = obj._listenId || (obj._listenId = _.uniqueId(<span class="string">'l'</span>));</div><div class="line">  <span class="keyword">var</span> listeningTo = <span class="keyword">this</span>._listeningTo || (<span class="keyword">this</span>._listeningTo = &#123;&#125;);</div><div class="line">  <span class="keyword">var</span> listening = _listening = listeningTo[id];</div><div class="line"></div><div class="line">  <span class="comment">// This object is not listening to any other events on `obj` yet.</span></div><div class="line">  <span class="comment">// Setup the necessary references to track the listening callbacks.</span></div><div class="line">  <span class="keyword">if</span> (!listening) &#123;</div><div class="line">    <span class="keyword">this</span>._listenId || (<span class="keyword">this</span>._listenId = _.uniqueId(<span class="string">'l'</span>));</div><div class="line">    listening = _listening = listeningTo[id] = <span class="keyword">new</span> Listening(<span class="keyword">this</span>, obj);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Bind callbacks on obj.</span></div><div class="line">  <span class="keyword">var</span> error = tryCatchOn(obj, name, callback, <span class="keyword">this</span>);</div><div class="line">  _listening = <span class="keyword">void</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</div><div class="line">  <span class="comment">// If the target obj is not Backbone.Events, track events manually.</span></div><div class="line">  <span class="keyword">if</span> (listening.interop) listening.on(name, callback);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>上述代码中用到的eventsApi,是标准的事件，回调迭代器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Iterates over the standard `event, callback` (as well as the fancy multiple</span></div><div class="line"><span class="comment">// space-separated events `"change blur", callback` and jQuery-style event</span></div><div class="line"><span class="comment">// maps `&#123;event: callback&#125;`).</span></div><div class="line"><span class="keyword">var</span> eventsApi = <span class="function"><span class="keyword">function</span>(<span class="params">iteratee, events, name, callback, opts</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> i = <span class="number">0</span>, names;</div><div class="line">  <span class="keyword">if</span> (name &amp;&amp; <span class="keyword">typeof</span> name === <span class="string">'object'</span>) &#123;</div><div class="line">    <span class="comment">// Handle event maps.</span></div><div class="line">    <span class="keyword">if</span> (callback !== <span class="keyword">void</span> <span class="number">0</span> &amp;&amp; <span class="string">'context'</span> <span class="keyword">in</span> opts &amp;&amp; opts.context === <span class="keyword">void</span> <span class="number">0</span>) opts.context = callback;</div><div class="line">    <span class="keyword">for</span> (names = _.keys(name); i &lt; names.length ; i++) &#123;</div><div class="line">      events = eventsApi(iteratee, events, names[i], name[names[i]], opts);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name &amp;&amp; eventSplitter.test(name)) &#123;</div><div class="line">    <span class="comment">// Handle space-separated event names by delegating them individually.</span></div><div class="line">    <span class="keyword">for</span> (names = name.split(eventSplitter); i &lt; names.length; i++) &#123;</div><div class="line">      events = iteratee(events, names[i], callback, opts);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Finally, standard events.</span></div><div class="line">    events = iteratee(events, name, callback, opts);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> events;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Backbone/">Backbone</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Events/">Events</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Framework/">Framework</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-es6-generator" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/24/es6-generator/" class="article-date">
  	<time datetime="2017-03-24T08:54:15.000Z" itemprop="datePublished">2017-03-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/24/es6-generator/">es6-generator</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>看babel官网上提供的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fibonacci = &#123;</div><div class="line">  [<span class="built_in">Symbol</span>.iterator]: <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> pre = <span class="number">0</span>, cur = <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">      <span class="keyword">var</span> temp = pre;</div><div class="line">      pre = cur;</div><div class="line">      cur += temp;</div><div class="line">      <span class="keyword">yield</span> cur;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> n <span class="keyword">of</span> fibonacci) &#123;</div><div class="line">  <span class="comment">// truncate the sequence at 1000</span></div><div class="line">  <span class="keyword">if</span> (n &gt; <span class="number">1000</span>)</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  <span class="built_in">console</span>.log(n);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在for…of…循环中，会调用迭代器对象的迭代器方法。之前那篇迭代器有提到过，但是这里的function*和普通的函数function不一样。如果是普通的函数，不管什么时候执行，得到的结果总是一样的（不考虑全局变量之类的干扰），或者说，和上一次无关。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6-ES2015/">ES6(ES2015)</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-dense-arrays" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/21/dense-arrays/" class="article-date">
  	<time datetime="2017-03-21T06:49:41.000Z" itemprop="datePublished">2017-03-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/21/dense-arrays/">Javascript中的稀疏数组 sparse arrays vs. 密集数组 dense arrays</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>大多数情况下，javascript中的数组是稀疏数组（其实就是k-v pairs），也就是说a[0], a[100]存在，但是a[1]到a[99]可能都不存在。</p>
<p>不存在，不是说存在但是是undefined,就是真正的不存在:如果用foreach访问并console.log，会发现根本没有这么一项，而不是输出一个undefined</p>
<p>实际上,JavaScript并没有常规的数组,所有的数组其实就是个对象,只不过会自动管理一些”数字”属性和length属性罢了.说的更直接一点,JavaScript中的数组根本没有索引,因为索引应该是数字,而JavaScript中数组的索引其实是字符串.arr[1]其实就是arr[“1”],给arr[“1000”] = 1,arr.length也会自动变为1001.这些表现的根本原因就是,JavaScript中的对象就是字符串到任意值的键值对.注意键只能是字符串</p>
<h3 id="sparse-arrays"><a href="#sparse-arrays" class="headerlink" title="sparse arrays"></a>sparse arrays</h3><ul>
<li>得到一个稀疏数组</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> sparseArr1 = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">3</span>);</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> sparseArr2 = [];</div><div class="line"></div><div class="line">sparseArr2[<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">sparseArr2[<span class="number">100</span>] = <span class="number">100</span>;</div></pre></td></tr></table></figure>
<ul>
<li>遍历稀疏数组，所有的“空隙”会被跳过<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> sparseArr2 = [];</div><div class="line"></div><div class="line">sparseArr2[<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">sparseArr2[<span class="number">100</span>] = <span class="number">100</span>;</div><div class="line"></div><div class="line">sparseArr2.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">index, val</span>) </span>&#123; <span class="built_in">console</span>.log(index); <span class="built_in">console</span>.log(val) &#125;) <span class="comment">// output: 1 0 100 100</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="dense-arrays"><a href="#dense-arrays" class="headerlink" title="dense arrays"></a>dense arrays</h3><ul>
<li>得到一个密集数组</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Array</span>(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>)</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> denseArr1 = <span class="built_in">Array</span>.apply(<span class="literal">null</span>, <span class="built_in">Array</span>(<span class="number">3</span>))；</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> denseArr2 = <span class="built_in">Array</span>.apply(<span class="literal">null</span>, <span class="built_in">Array</span>(<span class="number">3</span>)).map(<span class="built_in">Function</span>.prototype.call.bind(<span class="built_in">Number</span>))</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-destructuring" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/20/destructuring/" class="article-date">
  	<time datetime="2017-03-20T13:18:57.000Z" itemprop="datePublished">2017-03-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/20/destructuring/">ES6 - destructuring 整体析构赋值</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这个汉化——“ 整体析构赋值”——是抄的，我真的翻译不来。。。</p>
<h3 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h3><p>// list matching</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> [a, ,b] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</div><div class="line"></div><div class="line">a === <span class="number">1</span>;</div><div class="line">b === <span class="number">3</span>;</div></pre></td></tr></table></figure>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> obj = &#123; a: <span class="number">1</span>, b: <span class="number">2</span>, c: <span class="number">3</span>&#125;;</div><div class="line"><span class="keyword">const</span> &#123;a, c&#125; = obj;</div><div class="line"></div><div class="line">a === <span class="number">1</span>;</div><div class="line">c === <span class="number">3</span>;</div></pre></td></tr></table></figure>
<h3 id="function-parameters"><a href="#function-parameters" class="headerlink" title="function parameters"></a>function parameters</h3><ul>
<li>Can be used in parameter position</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params">&#123;name: x&#125;</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(x);</div><div class="line">&#125;</div><div class="line">g(&#123;name: <span class="number">5</span>&#125;)</div></pre></td></tr></table></figure>
<ul>
<li>Work with default args</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params">&#123;x, y, w = 10, h = 10&#125;</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> x + y + w + h;</div><div class="line">&#125;</div><div class="line">r(&#123;x:<span class="number">1</span>, y:<span class="number">2</span>&#125;) === <span class="number">23</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6-ES2015/">ES6(ES2015)</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-iterators" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/16/iterators/" class="article-date">
  	<time datetime="2017-03-16T14:01:56.000Z" itemprop="datePublished">2017-03-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/16/iterators/">iterators &amp; for...of... es6迭代器</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="用for…in…一定要小心！！"><a href="#用for…in…一定要小心！！" class="headerlink" title="用for…in…一定要小心！！"></a>用for…in…一定要小心！！</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myArray = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> myArray) &#123; <span class="comment">// never do this!!</span></div><div class="line">  <span class="built_in">console</span>.log(myArray[index]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>index不是number而是string，说不定就让自己掉进 ‘2’ + 1 == ‘21’ 这样的bug里了</li>
<li>for-in还会作用于自定义属性（myArray.name这种）</li>
<li>有些时候顺序是随机的</li>
</ul>
<p><strong> 简而言之，for-in是为普通对象设计的，你可以遍历得到字符串类型的键，因此不适用于数组遍历 </strong></p>
<h3 id="forEach的局限"><a href="#forEach的局限" class="headerlink" title=".forEach的局限"></a>.forEach的局限</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">myArray.forEach(funciton(val) &#123;</div><div class="line">  <span class="built_in">console</span>.log(val);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>不能使用break语句中断循环，也不能使用return语句返回到外层函数</p>
<h3 id="for…of-in-es6"><a href="#for…of-in-es6" class="headerlink" title="for…of in es6"></a>for…of in es6</h3><ul>
<li>正确响应break, continue</li>
<li>避免for…in的缺点</li>
<li>除了Array, 还可以遍历String, map, set</li>
</ul>
<h3 id="迭代器对象"><a href="#迭代器对象" class="headerlink" title="迭代器对象"></a>迭代器对象</h3><p>for-of循环语句通过方法调用来遍历各种集合。数组、Maps对象、Sets对象以及其它在我们讨论的对象有一个共同点，它们都有一个迭代器方法。</p>
<p>你可以给任意类型的对象添加迭代器方法。</p>
<p>当你为对象添加myObject.toString()方法后，就可以将对象转化为字符串，同样地，当你向任意对象添加myObject<a href="">Symbol.iterator</a>方法，就可以遍历这个对象了</p>
<p>for-of循环首先调用集合的<a href="">Symbol.iterator</a>方法，紧接着返回一个新的迭代器对象。迭代器对象可以是任意具有.next()方法的对象；for-of循环将重复调用这个方法，每次循环调用一次</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6/">ES6</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 体力劳动者
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: ''
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>